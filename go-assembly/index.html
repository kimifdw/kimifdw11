<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:inherit;font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);border-left-color:inherit;opacity:0.8;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:var(--hr);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"â€” ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:var(--textLink);text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a.gatsby-resp-image-link{box-shadow:none;}a.anchor{box-shadow:none;}a.anchor svg[aria-hidden="true"]{stroke:var(--textLink);}p code{font-size:1rem;}h1 code, h2 code, h3 code, h4 code, h5 code, h6 code{font-size:inherit;}li code{font-size:1rem;}blockquote.translation{font-size:1em;}</style><style data-href="/styles.37dea602fd4747235540.css">@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:400;src:url(/static/merriweather-400-i-l-9a3ea56a5f449980432ace5972181ef6.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:700;src:url(/static/merriweather-700-l-e24e02bb044cb07539a3a6bd12348d14.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:700;src:url(/static/merriweather-700-i-l-ad085ede31afcc5585ff34869b1cd029.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:400;src:url(/static/merriweather-400-l-8796b7875d52e9cb9b280211e8d3f82d.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:900;src:url(/static/montserrat-900-l-5751237264c0468be0d48ad1cea75b90.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}.react-toggle{touch-action:pan-x;display:inline-block;position:relative;cursor:pointer;background-color:transparent;border:0;padding:0;-webkit-touch-callout:none;-webkit-user-select:none;-ms-user-select:none;user-select:none;-webkit-tap-highlight-color:rgba(0,0,0,0);-webkit-tap-highlight-color:transparent}.react-toggle-screenreader-only{border:0;clip:rect(0 0 0 0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.react-toggle-track{width:50px;height:24px;padding:0;border-radius:30px;background-color:#0f1114;transition:all .2s ease}.react-toggle-track-check{position:absolute;width:17px;height:17px;left:5px;top:0;bottom:0;margin-top:auto;margin-bottom:auto;line-height:0;opacity:0;transition:opacity .25s ease}.react-toggle--checked .react-toggle-track-check,.react-toggle-track-x{opacity:1;transition:opacity .25s ease}.react-toggle-track-x{position:absolute;width:17px;height:17px;right:5px;top:0;bottom:0;margin-top:auto;margin-bottom:auto;line-height:0}.react-toggle--checked .react-toggle-track-x{opacity:0}.react-toggle-thumb{position:absolute;top:1px;left:1px;width:22px;height:22px;border-radius:50%;background-color:#fafafa;box-sizing:border-box;transition:all .5s cubic-bezier(.23,1,.32,1) 0ms;transform:translateX(0)}.react-toggle--checked .react-toggle-thumb{transform:translateX(26px);border-color:#19ab27}.react-toggle--focus .react-toggle-thumb{box-shadow:0 0 2px 3px var(--orange)}.react-toggle:active .react-toggle-thumb{box-shadow:0 0 5px 5px var(--orange)}body{--orange:#fe601c;background-color:var(--bg)}body.light{--bg:#fff;--header:var(--orange);--textNormal:#222;--textTitle:#222;--textLink:#e92d0d;--hr:rgba(0,0,0,0.2);--inlineCode-bg:rgba(255,229,100,0.2);--inlineCode-text:#1a1a1a}body.dark{-webkit-font-smoothing:antialiased;--bg:#282c35;--header:#fff;--textNormal:hsla(0,0%,100%,0.88);--textTitle:#fff;--textLink:var(--orange);--hr:hsla(0,0%,100%,0.2);--inlineCode-bg:#373c49;--inlineCode-text:#e6e6e6}body:lang(ar) article,body:lang(fa) article{direction:rtl}body:lang(ar) .language-text,body:lang(ar) article .translations,body:lang(ar) article pre,body:lang(fa) .language-text,body:lang(fa) article .translations,body:lang(fa) article pre{direction:ltr}body:lang(ar) .language-text,body:lang(fa) .language-text{display:inline-block}body:lang(ar) blockquote,body:lang(fa) blockquote{border-left:unset;border-right:.32813rem solid rgba(0,0,0,.9);padding-right:1.42188rem;padding-left:unset;margin-left:.75rem;margin-right:-1.75rem}body:lang(fa) article,body:lang(fa) header>h1{font-family:Vazir}body:lang(ar) article,body:lang(ar) header>h1{font-family:Cairo,sans-serif}body:lang(ko) article,body:lang(ko) header{word-break:keep-all}code[class*=language-],pre[class*=language-]{color:#fff;background:none;font-family:Consolas,Menlo,Monaco,source-code-pro,Courier New,monospace;font-feature-settings:normal;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;margin-bottom:0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{overflow:auto;padding:1.3125rem}pre[class*=language-]::selection{background:#27292a}pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:hsla(0,0%,100%,.15)}:not(pre)>code[class*=language-]{border-radius:.3em;background:var(--inlineCode-bg);color:var(--inlineCode-text);padding:.15em .2em .05em;white-space:normal}.token.attr-name{color:#addb67;font-style:italic}.token.comment{color:#809393}.token.string,.token.url{color:#addb67}.token.variable{color:#d6deeb}.token.number{color:#f78c6c}.token.builtin,.token.char,.token.constant,.token.function{color:#82aaff}.token.punctuation{color:#c792ea}.token.doctype,.token.selector{color:#c792ea;font-style:"italic"}.token.class-name{color:#ffcb8b}.token.keyword,.token.operator,.token.tag{color:#ffa7c4}.token.boolean{color:#ff5874}.token.property{color:#80cbc4}.token.namespace{color:#b2ccd6}pre[data-line]{padding:1em 0 1em 3em;position:relative}.gatsby-highlight-code-line{background-color:#022a4b;display:block;padding-right:1em;padding-left:1.25em;border-left:.25em solid #ffa7c4}.gatsby-highlight,.gatsby-highlight-code-line{margin-right:-1.3125rem;margin-left:-1.3125rem}.gatsby-highlight{margin-bottom:1.75rem;border-radius:10px;background:#011627;-webkit-overflow-scrolling:touch;overflow:auto}@media (max-width:672px){.gatsby-highlight{border-radius:0}}.gatsby-highlight pre[class*=language-]{float:left;min-width:100%}</style><meta name="generator" content="Gatsby 2.24.83"/><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><link rel="icon" href="/favicon-32x32.png?v=92dcab1797689d6d87ef20dd22c47be6" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=92dcab1797689d6d87ef20dd22c47be6"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=92dcab1797689d6d87ef20dd22c47be6"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=92dcab1797689d6d87ef20dd22c47be6"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=92dcab1797689d6d87ef20dd22c47be6"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=92dcab1797689d6d87ef20dd22c47be6"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=92dcab1797689d6d87ef20dd22c47be6"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=92dcab1797689d6d87ef20dd22c47be6"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=92dcab1797689d6d87ef20dd22c47be6"/><title data-react-helmet="true">plan9 assembly å®Œå…¨è§£æã€è½¬ã€‘ â€” F&amp;Y-BLOG</title><meta data-react-helmet="true" name="theme-color" content="#282c35"/><meta data-react-helmet="true" name="description" content="golang,plan9,assembly"/><meta data-react-helmet="true" property="og:url" content="https://kimifdw.github.io/go-assembly/"/><meta data-react-helmet="true" property="og:title" content="plan9 assembly å®Œå…¨è§£æã€è½¬ã€‘"/><meta data-react-helmet="true" property="og:description" content="golang,plan9,assembly"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="@kimifdw"/><meta data-react-helmet="true" name="twitter:title" content="plan9 assembly å®Œå…¨è§£æã€è½¬ã€‘"/><meta data-react-helmet="true" name="twitter:description" content="golang,plan9,assembly"/><link as="script" rel="preload" href="/webpack-runtime-dfdca0602395678500cb.js"/><link as="script" rel="preload" href="/framework-9f754d8b33503a24e84f.js"/><link as="script" rel="preload" href="/app-454927e492eeae3dba5d.js"/><link as="script" rel="preload" href="/styles-e9d24b1846c7d6eb9685.js"/><link as="script" rel="preload" href="/commons-c4326062fba27c33e039.js"/><link as="script" rel="preload" href="/b42287b7de2077c8bbdf81b8173430c75bb9d1ba-15e706e384a6a6b62cfa.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-a5cf8e1f925daa84ad58.js"/><link as="fetch" rel="preload" href="/page-data/go-assembly/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/336482444.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body class="light"><script>
              (function() {
                window.__onThemeChange = function() {};
                function setTheme(newTheme) {
                  window.__theme = newTheme;
                  preferredTheme = newTheme;
                  document.body.className = newTheme;
                  window.__onThemeChange(newTheme);
                }

                var preferredTheme;
                try {
                  preferredTheme = localStorage.getItem('theme');
                } catch (err) { }

                window.__setPreferredTheme = function(newTheme) {
                  setTheme(newTheme);
                  try {
                    localStorage.setItem('theme', newTheme);
                  } catch (err) {}
                }

                var darkQuery = window.matchMedia('(prefers-color-scheme: dark)');
                darkQuery.addListener(function(e) {
                  window.__setPreferredTheme(e.matches ? 'dark' : 'light')
                });

                setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'));
              })();
            </script><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="color:var(--textNormal);background:var(--bg);transition:color 0.2s ease-out, background 0.2s ease-out;min-height:100vh"><div style="margin-left:auto;margin-right:auto;max-width:42rem;padding:2.625rem 1.3125rem"><header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2.625rem"><h3 style="font-family:Montserrat, sans-serif;margin-top:0;margin-bottom:0;height:42px;line-height:2.625rem"><a style="box-shadow:none;text-decoration:none;color:var(--orange)" href="/">F&amp;Y-BLOG</a></h3><div style="height:24px"></div></header><main><article><header><h1 style="color:var(--textTitle)">plan9 assembly å®Œå…¨è§£æã€è½¬ã€‘</h1><p style="font-size:0.83255rem;line-height:1.75rem;display:block;margin-bottom:1.75rem;margin-top:-1.4rem">10/23/2020<!-- --> â€¢ ğŸ±ğŸ± 28 min read</p></header><div><p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒGo ä½¿ç”¨äº† Unix è€å¤è‘£(è¯¯ ä»¬å‘æ˜çš„ plan9 æ±‡ç¼–ã€‚å°±ç®—ä½ å¯¹ x86 æ±‡ç¼–æœ‰æ‰€äº†è§£ï¼Œåœ¨ plan9 é‡Œè¿˜æ˜¯æœ‰äº›è®¸åŒºåˆ«ã€‚è¯´ä¸å®šä½ åœ¨çœ‹ä»£ç çš„æ—¶å€™ï¼Œå¶ç„¶å‘ç°ä»£ç é‡Œçš„ SP çœ‹èµ·æ¥æ˜¯ SPï¼Œä½†å®ƒå®é™…ä¸Šä¸æ˜¯ SP çš„æ—¶å€™å°±æŠ“ç‹‚äº†å“ˆå“ˆå“ˆã€‚</p>
<p>æœ¬æ–‡å°†å¯¹ plan9 æ±‡ç¼–è¿›è¡Œå…¨é¢çš„ä»‹ç»ï¼ŒåŒæ—¶è§£ç­”ä½ åœ¨æ¥è§¦ plan9 æ±‡ç¼–æ—¶å¯èƒ½é‡åˆ°çš„å¤§éƒ¨åˆ†é—®é¢˜ã€‚</p>
<p>æœ¬æ–‡æ‰€ä½¿ç”¨çš„å¹³å°æ˜¯ linux amd64ï¼Œå› ä¸ºä¸åŒçš„å¹³å°æŒ‡ä»¤é›†å’Œå¯„å­˜å™¨éƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥æ²¡æœ‰åŠæ³•å…±åŒæ¢è®¨ã€‚è¿™ä¹Ÿæ˜¯ç”±æ±‡ç¼–æœ¬èº«çš„æ€§è´¨å†³å®šçš„ã€‚</p>
<h2 id="åŸºæœ¬æŒ‡ä»¤"><a href="#%E5%9F%BA%E6%9C%AC%E6%8C%87%E4%BB%A4" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>åŸºæœ¬æŒ‡ä»¤</h2>
<h3 id="æ ˆè°ƒæ•´"><a href="#%E6%A0%88%E8%B0%83%E6%95%B4" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>æ ˆè°ƒæ•´</h3>
<p>intel æˆ– AT&#x26;T æ±‡ç¼–æä¾›äº† push å’Œ pop æŒ‡ä»¤æ—ï¼Œplan9 ä¸­æ²¡æœ‰ push å’Œ popï¼Œæ ˆçš„è°ƒæ•´æ˜¯é€šè¿‡å¯¹ç¡¬ä»¶ SP å¯„å­˜å™¨è¿›è¡Œè¿ç®—æ¥å®ç°çš„ï¼Œä¾‹å¦‚:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">SUBQ $<span class="token number">0x18</span><span class="token punctuation">,</span> SP <span class="token comment">// å¯¹ SP åšå‡æ³•ï¼Œä¸ºå‡½æ•°åˆ†é…å‡½æ•°æ ˆå¸§</span>
<span class="token operator">...</span>               <span class="token comment">// çœç•¥æ— ç”¨ä»£ç </span>
ADDQ $<span class="token number">0x18</span><span class="token punctuation">,</span> SP <span class="token comment">// å¯¹ SP åšåŠ æ³•ï¼Œæ¸…é™¤å‡½æ•°æ ˆå¸§</span></code></pre></div>
<p>é€šç”¨çš„æŒ‡ä»¤å’Œ X64 å¹³å°å·®ä¸å¤šï¼Œä¸‹é¢åˆ†èŠ‚è¯¦è¿°ã€‚</p>
<h3 id="æ•°æ®æ¬è¿"><a href="#%E6%95%B0%E6%8D%AE%E6%90%AC%E8%BF%90" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>æ•°æ®æ¬è¿</h3>
<p>å¸¸æ•°åœ¨ plan9 æ±‡ç¼–ç”¨ $num è¡¨ç¤ºï¼Œå¯ä»¥ä¸ºè´Ÿæ•°ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸ºåè¿›åˆ¶ã€‚å¯ä»¥ç”¨ $0x123 çš„å½¢å¼æ¥è¡¨ç¤ºåå…­è¿›åˆ¶æ•°ã€‚</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">MOVB $<span class="token number">1</span><span class="token punctuation">,</span> DI      <span class="token comment">// 1 byte</span>
MOVW $<span class="token number">0x10</span><span class="token punctuation">,</span> BX   <span class="token comment">// 2 bytes</span>
MOVD $<span class="token number">1</span><span class="token punctuation">,</span> DX      <span class="token comment">// 4 bytes</span>
MOVQ $<span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span> AX     <span class="token comment">// 8 bytes</span></code></pre></div>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæ¬è¿çš„é•¿åº¦æ˜¯ç”± MOV çš„åç¼€å†³å®šçš„ï¼Œè¿™ä¸€ç‚¹ä¸ intel æ±‡ç¼–ç¨æœ‰ä¸åŒï¼Œçœ‹çœ‹ç±»ä¼¼çš„ X64 æ±‡ç¼–:</p>
<div class="gatsby-highlight" data-language="asm"><pre class="language-asm"><code class="language-asm">mov rax, 0x1   // 8 bytes
mov eax, 0x100 // 4 bytes
mov ax, 0x22   // 2 bytes
mov ah, 0x33   // 1 byte
mov al, 0x44   // 1 byte</code></pre></div>
<p>plan9 çš„æ±‡ç¼–çš„æ“ä½œæ•°çš„æ–¹å‘æ˜¯å’Œ intel æ±‡ç¼–ç›¸åçš„ï¼Œä¸ AT&#x26;T ç±»ä¼¼ã€‚</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">MOVQ $<span class="token number">0x10</span><span class="token punctuation">,</span> AX <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span> mov rax<span class="token punctuation">,</span> <span class="token number">0x10</span>
       <span class="token operator">|</span>    <span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>      <span class="token operator">|</span>
       <span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span></code></pre></div>
<p>ä¸è¿‡å‡¡äº‹æ€»æœ‰ä¾‹å¤–ï¼Œå¦‚æœæƒ³äº†è§£è¿™ç§æ„å¤–ï¼Œå¯ä»¥å‚è§å‚è€ƒèµ„æ–™ä¸­çš„ [1]ã€‚</p>
<h3 id="å¸¸è§è®¡ç®—æŒ‡ä»¤"><a href="#%E5%B8%B8%E8%A7%81%E8%AE%A1%E7%AE%97%E6%8C%87%E4%BB%A4" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>å¸¸è§è®¡ç®—æŒ‡ä»¤</h3>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">ADDQ  AX<span class="token punctuation">,</span> BX   <span class="token comment">// BX += AX</span>
SUBQ  AX<span class="token punctuation">,</span> BX   <span class="token comment">// BX -= AX</span>
IMULQ AX<span class="token punctuation">,</span> BX   <span class="token comment">// BX *= AX</span></code></pre></div>
<p>ç±»ä¼¼æ•°æ®æ¬è¿æŒ‡ä»¤ï¼ŒåŒæ ·å¯ä»¥é€šè¿‡ä¿®æ”¹æŒ‡ä»¤çš„åç¼€æ¥å¯¹åº”ä¸åŒé•¿åº¦çš„æ“ä½œæ•°ã€‚ä¾‹å¦‚ ADDQ/ADDW/ADDL/ADDBã€‚</p>
<h3 id="æ¡ä»¶è·³è½¬æ— æ¡ä»¶è·³è½¬"><a href="#%E6%9D%A1%E4%BB%B6%E8%B7%B3%E8%BD%AC%E6%97%A0%E6%9D%A1%E4%BB%B6%E8%B7%B3%E8%BD%AC" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>æ¡ä»¶è·³è½¬/æ— æ¡ä»¶è·³è½¬</h3>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token comment">// æ— æ¡ä»¶è·³è½¬</span>
JMP addr   <span class="token comment">// è·³è½¬åˆ°åœ°å€ï¼Œåœ°å€å¯ä¸ºä»£ç ä¸­çš„åœ°å€ï¼Œä¸è¿‡å®é™…ä¸Šæ‰‹å†™ä¸ä¼šå‡ºç°è¿™ç§ä¸œè¥¿</span>
JMP label  <span class="token comment">// è·³è½¬åˆ°æ ‡ç­¾ï¼Œå¯ä»¥è·³è½¬åˆ°åŒä¸€å‡½æ•°å†…çš„æ ‡ç­¾ä½ç½®</span>
JMP <span class="token function">2</span><span class="token punctuation">(</span>PC<span class="token punctuation">)</span>  <span class="token comment">// ä»¥å½“å‰æŒ‡ä»¤ä¸ºåŸºç¡€ï¼Œå‘å‰/åè·³è½¬ x è¡Œ</span>
JMP <span class="token operator">-</span><span class="token function">2</span><span class="token punctuation">(</span>PC<span class="token punctuation">)</span> <span class="token comment">// åŒä¸Š</span>

<span class="token comment">// æœ‰æ¡ä»¶è·³è½¬</span>
JZ target <span class="token comment">// å¦‚æœ zero flag è¢« set è¿‡ï¼Œåˆ™è·³è½¬</span></code></pre></div>
<h3 id="æŒ‡ä»¤é›†"><a href="#%E6%8C%87%E4%BB%A4%E9%9B%86" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>æŒ‡ä»¤é›†</h3>
<p>å¯ä»¥å‚è€ƒæºä»£ç çš„ <a href="https://github.com/golang/arch/blob/master/x86/x86.csv" target="_blank" rel="nofollow noopener noreferrer">arch</a> éƒ¨åˆ†ã€‚</p>
<p>é¢å¤–æä¸€å¥ï¼ŒGo 1.10 æ·»åŠ äº†å¤§é‡çš„ SIMD æŒ‡ä»¤æ”¯æŒï¼Œæ‰€ä»¥åœ¨è¯¥ç‰ˆæœ¬ä»¥ä¸Šçš„è¯ï¼Œä¸åƒä¹‹å‰å†™é‚£æ ·ç—›è‹¦äº†ï¼Œä¹Ÿå°±æ˜¯ä¸ç”¨äººè‚‰å¡« byte äº†ã€‚</p>
<h2 id="å¯„å­˜å™¨"><a href="#%E5%AF%84%E5%AD%98%E5%99%A8" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>å¯„å­˜å™¨</h2>
<h3 id="é€šç”¨å¯„å­˜å™¨"><a href="#%E9%80%9A%E7%94%A8%E5%AF%84%E5%AD%98%E5%99%A8" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>é€šç”¨å¯„å­˜å™¨</h3>
<p>amd64 çš„é€šç”¨å¯„å­˜å™¨:</p>
<div class="gatsby-highlight" data-language="gdb"><pre class="language-gdb"><code class="language-gdb">(lldb) reg read
General Purpose Registers:
       rax = 0x0000000000000005
       rbx = 0x000000c420088000
       rcx = 0x0000000000000000
       rdx = 0x0000000000000000
       rdi = 0x000000c420088008
       rsi = 0x0000000000000000
       rbp = 0x000000c420047f78
       rsp = 0x000000c420047ed8
        r8 = 0x0000000000000004
        r9 = 0x0000000000000000
       r10 = 0x000000c420020001
       r11 = 0x0000000000000202
       r12 = 0x0000000000000000
       r13 = 0x00000000000000f1
       r14 = 0x0000000000000011
       r15 = 0x0000000000000001
       rip = 0x000000000108ef85  int`main.main + 213 at int.go:19
    rflags = 0x0000000000000212
        cs = 0x000000000000002b
        fs = 0x0000000000000000
        gs = 0x0000000000000000</code></pre></div>
<p>åœ¨ plan9 æ±‡ç¼–é‡Œéƒ½æ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼Œåº”ç”¨ä»£ç å±‚é¢ä¼šç”¨åˆ°çš„é€šç”¨å¯„å­˜å™¨ä¸»è¦æ˜¯: rax, rbx, rcx, rdx, rdi, rsi, r8~r15 è¿™ 14 ä¸ªå¯„å­˜å™¨ï¼Œè™½ç„¶ rbp å’Œ rsp ä¹Ÿå¯ä»¥ç”¨ï¼Œä¸è¿‡ bp å’Œ sp ä¼šè¢«ç”¨æ¥ç®¡ç†æ ˆé¡¶å’Œæ ˆåº•ï¼Œæœ€å¥½ä¸è¦æ‹¿æ¥è¿›è¡Œè¿ç®—ã€‚</p>
<p>plan9 ä¸­ä½¿ç”¨å¯„å­˜å™¨ä¸éœ€è¦å¸¦ r æˆ– e çš„å‰ç¼€ï¼Œä¾‹å¦‚ raxï¼Œåªè¦å†™ AX å³å¯:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">MOVQ $<span class="token number">101</span><span class="token punctuation">,</span> AX <span class="token operator">=</span> mov rax<span class="token punctuation">,</span> <span class="token number">101</span></code></pre></div>
<p>ä¸‹é¢æ˜¯é€šç”¨é€šç”¨å¯„å­˜å™¨çš„åå­—åœ¨ X64 å’Œ plan9 ä¸­çš„å¯¹åº”å…³ç³»:</p>
<table>
<thead>
<tr>
<th>X64</th>
<th>rax</th>
<th>rbx</th>
<th>rcx</th>
<th>rdx</th>
<th>rdi</th>
<th>rsi</th>
<th>rbp</th>
<th>rsp</th>
<th>r8</th>
<th>r9</th>
<th>r10</th>
<th>r11</th>
<th>r12</th>
<th>r13</th>
<th>r14</th>
<th>rip</th>
</tr>
</thead>
<tbody>
<tr>
<td>Plan9</td>
<td>AX</td>
<td>BX</td>
<td>CX</td>
<td>DX</td>
<td>DI</td>
<td>SI</td>
<td>BP</td>
<td>SP</td>
<td>R8</td>
<td>R9</td>
<td>R10</td>
<td>R11</td>
<td>R12</td>
<td>R13</td>
<td>R14</td>
<td>PC</td>
</tr>
</tbody>
</table>
<h3 id="ä¼ªå¯„å­˜å™¨"><a href="#%E4%BC%AA%E5%AF%84%E5%AD%98%E5%99%A8" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ä¼ªå¯„å­˜å™¨</h3>
<p>Go çš„æ±‡ç¼–è¿˜å¼•å…¥äº† 4 ä¸ªä¼ªå¯„å­˜å™¨ï¼Œæ´å¼•å®˜æ–¹æ–‡æ¡£çš„æè¿°:</p>
<blockquote>
<ul>
<li><code class="language-text">FP</code>: Frame pointer: arguments and locals.</li>
<li><code class="language-text">PC</code>: Program counter: jumps and branches.</li>
<li><code class="language-text">SB</code>: Static base pointer: global symbols.</li>
<li><code class="language-text">SP</code>: Stack pointer: top of stack.</li>
</ul>
</blockquote>
<p>å®˜æ–¹çš„æè¿°ç¨å¾®æœ‰ä¸€äº›é—®é¢˜ï¼Œæˆ‘ä»¬å¯¹è¿™äº›è¯´æ˜è¿›è¡Œä¸€ç‚¹æ‰©å……:</p>
<ul>
<li>FP:  ä½¿ç”¨å½¢å¦‚ <code class="language-text">symbol+offset(FP)</code> çš„æ–¹å¼ï¼Œå¼•ç”¨å‡½æ•°çš„è¾“å…¥å‚æ•°ã€‚ä¾‹å¦‚ <code class="language-text">arg0+0(FP)</code>ï¼Œ<code class="language-text">arg1+8(FP)</code>ï¼Œä½¿ç”¨ FP ä¸åŠ  symbol æ—¶ï¼Œæ— æ³•é€šè¿‡ç¼–è¯‘ï¼Œåœ¨æ±‡ç¼–å±‚é¢æ¥è®²ï¼Œsymbol å¹¶æ²¡æœ‰ä»€ä¹ˆç”¨ï¼ŒåŠ  symbol ä¸»è¦æ˜¯ä¸ºäº†æå‡ä»£ç å¯è¯»æ€§ã€‚å¦å¤–ï¼Œå®˜æ–¹æ–‡æ¡£è™½ç„¶å°†ä¼ªå¯„å­˜å™¨ FP ç§°ä¹‹ä¸º frame pointerï¼Œå®é™…ä¸Šå®ƒæ ¹æœ¬ä¸æ˜¯ frame pointerï¼ŒæŒ‰ç…§ä¼ ç»Ÿçš„ x86 çš„ä¹ æƒ¯æ¥è®²ï¼Œframe pointer æ˜¯æŒ‡å‘æ•´ä¸ª stack frame åº•éƒ¨çš„ BP å¯„å­˜å™¨ã€‚å‡å¦‚å½“å‰çš„ callee å‡½æ•°æ˜¯ addï¼Œåœ¨ add çš„ä»£ç ä¸­å¼•ç”¨ FPï¼Œè¯¥ FP æŒ‡å‘çš„ä½ç½®ä¸åœ¨ callee çš„ stack frame ä¹‹å†…ï¼Œè€Œæ˜¯åœ¨ caller çš„ stack frame ä¸Šã€‚å…·ä½“å¯å‚è§ä¹‹åçš„ <strong>æ ˆç»“æ„</strong> ä¸€ç« ã€‚</li>
<li>PC: å®é™…ä¸Šå°±æ˜¯åœ¨ä½“ç³»ç»“æ„çš„çŸ¥è¯†ä¸­å¸¸è§çš„ pc å¯„å­˜å™¨ï¼Œåœ¨ x86 å¹³å°ä¸‹å¯¹åº” ip å¯„å­˜å™¨ï¼Œamd64 ä¸Šåˆ™æ˜¯ ripã€‚é™¤äº†ä¸ªåˆ«è·³è½¬ä¹‹å¤–ï¼Œæ‰‹å†™ plan9 ä»£ç ä¸ PC å¯„å­˜å™¨æ‰“äº¤é“çš„æƒ…å†µè¾ƒå°‘ã€‚</li>
<li>SB: å…¨å±€é™æ€åŸºæŒ‡é’ˆï¼Œä¸€èˆ¬ç”¨æ¥å£°æ˜å‡½æ•°æˆ–å…¨å±€å˜é‡ï¼Œåœ¨ä¹‹åçš„å‡½æ•°çŸ¥è¯†å’Œç¤ºä¾‹éƒ¨åˆ†ä¼šçœ‹åˆ°å…·ä½“ç”¨æ³•ã€‚</li>
<li>SP: plan9 çš„è¿™ä¸ª SP å¯„å­˜å™¨æŒ‡å‘å½“å‰æ ˆå¸§çš„å±€éƒ¨å˜é‡çš„å¼€å§‹ä½ç½®ï¼Œä½¿ç”¨å½¢å¦‚ <code class="language-text">symbol+offset(SP)</code> çš„æ–¹å¼ï¼Œå¼•ç”¨å‡½æ•°çš„å±€éƒ¨å˜é‡ã€‚offset çš„åˆæ³•å–å€¼æ˜¯ [-framesize, 0)ï¼Œæ³¨æ„æ˜¯ä¸ªå·¦é—­å³å¼€çš„åŒºé—´ã€‚å‡å¦‚å±€éƒ¨å˜é‡éƒ½æ˜¯ 8 å­—èŠ‚ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå±€éƒ¨å˜é‡å°±å¯ä»¥ç”¨ <code class="language-text">localvar0-8(SP)</code> æ¥è¡¨ç¤ºã€‚è¿™ä¹Ÿæ˜¯ä¸€ä¸ªè¯ä¸è¡¨æ„çš„å¯„å­˜å™¨ã€‚ä¸ç¡¬ä»¶å¯„å­˜å™¨ SP æ˜¯ä¸¤ä¸ªä¸åŒçš„ä¸œè¥¿ï¼Œåœ¨æ ˆå¸§ size ä¸º 0 çš„æƒ…å†µä¸‹ï¼Œä¼ªå¯„å­˜å™¨ SP å’Œç¡¬ä»¶å¯„å­˜å™¨ SP æŒ‡å‘åŒä¸€ä½ç½®ã€‚æ‰‹å†™æ±‡ç¼–ä»£ç æ—¶ï¼Œå¦‚æœæ˜¯ <code class="language-text">symbol+offset(SP)</code> å½¢å¼ï¼Œåˆ™è¡¨ç¤ºä¼ªå¯„å­˜å™¨ SPã€‚å¦‚æœæ˜¯ <code class="language-text">offset(SP)</code> åˆ™è¡¨ç¤ºç¡¬ä»¶å¯„å­˜å™¨ SPã€‚åŠ¡å¿…æ³¨æ„ã€‚å¯¹äºç¼–è¯‘è¾“å‡º(go tool compile -S / go tool objdump)çš„ä»£ç æ¥è®²ï¼Œç›®å‰æ‰€æœ‰çš„ SP éƒ½æ˜¯ç¡¬ä»¶å¯„å­˜å™¨ SPï¼Œæ— è®ºæ˜¯å¦å¸¦ symbolã€‚</li>
</ul>
<p>æˆ‘ä»¬è¿™é‡Œå¯¹å®¹æ˜“æ··æ·†çš„å‡ ç‚¹ç®€å•è¿›è¡Œè¯´æ˜ï¼š</p>
<ol>
<li>ä¼ª SP å’Œç¡¬ä»¶ SP ä¸æ˜¯ä¸€å›äº‹ï¼Œåœ¨æ‰‹å†™ä»£ç æ—¶ï¼Œä¼ª SP å’Œç¡¬ä»¶ SP çš„åŒºåˆ†æ–¹æ³•æ˜¯çœ‹è¯¥ SP å‰æ˜¯å¦æœ‰ symbolã€‚å¦‚æœæœ‰ symbolï¼Œé‚£ä¹ˆå³ä¸ºä¼ªå¯„å­˜å™¨ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆè¯´æ˜æ˜¯ç¡¬ä»¶ SP å¯„å­˜å™¨ã€‚</li>
<li>SP å’Œ FP çš„ç›¸å¯¹ä½ç½®æ˜¯ä¼šå˜çš„ï¼Œæ‰€ä»¥ä¸åº”è¯¥å°è¯•ç”¨ä¼ª SP å¯„å­˜å™¨å»æ‰¾é‚£äº›ç”¨ FP + offset æ¥å¼•ç”¨çš„å€¼ï¼Œä¾‹å¦‚å‡½æ•°çš„å…¥å‚å’Œè¿”å›å€¼ã€‚</li>
<li>å®˜æ–¹æ–‡æ¡£ä¸­è¯´çš„ä¼ª SP æŒ‡å‘ stack çš„ topï¼Œæ˜¯æœ‰é—®é¢˜çš„ã€‚å…¶æŒ‡å‘çš„å±€éƒ¨å˜é‡ä½ç½®å®é™…ä¸Šæ˜¯æ•´ä¸ªæ ˆçš„æ ˆåº•(é™¤ caller BP ä¹‹å¤–)ï¼Œæ‰€ä»¥è¯´ bottom æ›´åˆé€‚ä¸€äº›ã€‚</li>
<li>åœ¨ go tool objdump/go tool compile -S è¾“å‡ºçš„ä»£ç ä¸­ï¼Œæ˜¯æ²¡æœ‰ä¼ª SP å’Œ FP å¯„å­˜å™¨çš„ï¼Œæˆ‘ä»¬ä¸Šé¢è¯´çš„åŒºåˆ†ä¼ª SP å’Œç¡¬ä»¶ SP å¯„å­˜å™¨çš„æ–¹æ³•ï¼Œå¯¹äºä¸Šè¿°ä¸¤ä¸ªå‘½ä»¤çš„è¾“å‡ºç»“æœæ˜¯æ²¡æ³•ä½¿ç”¨çš„ã€‚åœ¨ç¼–è¯‘å’Œåæ±‡ç¼–çš„ç»“æœä¸­ï¼Œåªæœ‰çœŸå®çš„ SP å¯„å­˜å™¨ã€‚</li>
<li>FP å’Œ Go çš„å®˜æ–¹æºä»£ç é‡Œçš„ framepointer ä¸æ˜¯ä¸€å›äº‹ï¼Œæºä»£ç é‡Œçš„ framepointer æŒ‡çš„æ˜¯ caller BP å¯„å­˜å™¨çš„å€¼ï¼Œåœ¨è¿™é‡Œå’Œ caller çš„ä¼ª SP æ˜¯å€¼æ˜¯ç›¸ç­‰çš„ã€‚</li>
</ol>
<p>ä»¥ä¸Šè¯´æ˜çœ‹ä¸æ‡‚ä¹Ÿæ²¡å…³ç³»ï¼Œåœ¨ç†Ÿæ‚‰äº†å‡½æ•°çš„æ ˆç»“æ„ä¹‹åå†åå¤å›æ¥æŸ¥çœ‹åº”è¯¥å°±å¯ä»¥æ˜ç™½äº†ã€‚ä¸ªäººæ„è§ï¼Œè¿™äº›æ˜¯ Go å®˜æ–¹æŒ–çš„å‘ã€‚ã€‚</p>
<h2 id="å˜é‡å£°æ˜"><a href="#%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>å˜é‡å£°æ˜</h2>
<p>åœ¨æ±‡ç¼–é‡Œæ‰€è°“çš„å˜é‡ï¼Œä¸€èˆ¬æ˜¯å­˜å‚¨åœ¨ .rodata æˆ–è€… .data æ®µä¸­çš„åªè¯»å€¼ã€‚å¯¹åº”åˆ°åº”ç”¨å±‚çš„è¯ï¼Œå°±æ˜¯å·²åˆå§‹åŒ–è¿‡çš„å…¨å±€çš„ constã€varã€static å˜é‡/å¸¸é‡ã€‚</p>
<p>ä½¿ç”¨ DATA ç»“åˆ GLOBL æ¥å®šä¹‰ä¸€ä¸ªå˜é‡ã€‚DATA çš„ç”¨æ³•ä¸º:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">DATA    symbol<span class="token operator">+</span><span class="token function">offset</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token operator">/</span>width<span class="token punctuation">,</span> value</code></pre></div>
<p>å¤§å¤šæ•°å‚æ•°éƒ½æ˜¯å­—é¢æ„æ€ï¼Œä¸è¿‡è¿™ä¸ª offset éœ€è¦ç¨å¾®æ³¨æ„ã€‚å…¶å«ä¹‰æ˜¯è¯¥å€¼ç›¸å¯¹äºç¬¦å· symbol çš„åç§»ï¼Œè€Œä¸æ˜¯ç›¸å¯¹äºå…¨å±€æŸä¸ªåœ°å€çš„åç§»ã€‚</p>
<p>ä½¿ç”¨ GLOBL æŒ‡ä»¤å°†å˜é‡å£°æ˜ä¸º globalï¼Œé¢å¤–æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ flagï¼Œå¦ä¸€ä¸ªæ˜¯å˜é‡çš„æ€»å¤§å°ã€‚</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">GLOBL <span class="token function">divtab</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> RODATA<span class="token punctuation">,</span> $<span class="token number">64</span></code></pre></div>
<p>GLOBL å¿…é¡»è·Ÿåœ¨ DATA æŒ‡ä»¤ä¹‹åï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªå®šä¹‰äº†å¤šä¸ª readonly çš„å…¨å±€å˜é‡çš„å®Œæ•´ä¾‹å­:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">DATA age<span class="token operator">+</span><span class="token function">0x00</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">,</span> $<span class="token number">18</span>  <span class="token comment">// forever 18</span>
GLOBL <span class="token function">age</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> RODATA<span class="token punctuation">,</span> $<span class="token number">4</span>

DATA pi<span class="token operator">+</span><span class="token function">0</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">,</span> $<span class="token number">3.1415926</span>
GLOBL <span class="token function">pi</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> RODATA<span class="token punctuation">,</span> $<span class="token number">8</span>

DATA birthYear<span class="token operator">+</span><span class="token function">0</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">,</span> $<span class="token number">1988</span>
GLOBL <span class="token function">birthYear</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> RODATA<span class="token punctuation">,</span> $<span class="token number">4</span></code></pre></div>
<p>æ­£å¦‚ä¹‹å‰æ‰€è¯´ï¼Œæ‰€æœ‰ç¬¦å·åœ¨å£°æ˜æ—¶ï¼Œå…¶ offset ä¸€èˆ¬éƒ½æ˜¯ 0ã€‚</p>
<p>æœ‰æ—¶ä¹Ÿå¯èƒ½ä¼šæƒ³åœ¨å…¨å±€å˜é‡ä¸­å®šä¹‰æ•°ç»„ï¼Œæˆ–å­—ç¬¦ä¸²ï¼Œè¿™æ—¶å€™å°±éœ€è¦ç”¨ä¸Šé 0 çš„ offset äº†ï¼Œä¾‹å¦‚:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">DATA bio<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">+</span><span class="token function">0</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">,</span> $<span class="token string">"oh yes i"</span>
DATA bio<span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">+</span><span class="token function">8</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">,</span> $<span class="token string">"am here "</span>
GLOBL bio<span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> RODATA<span class="token punctuation">,</span> $<span class="token number">16</span></code></pre></div>
<p>å¤§éƒ¨åˆ†éƒ½æ¯”è¾ƒå¥½ç†è§£ï¼Œä¸è¿‡è¿™é‡Œæˆ‘ä»¬åˆå¼•å…¥äº†æ–°çš„æ ‡è®° <code class="language-text">&lt;&gt;</code>ï¼Œè¿™ä¸ªè·Ÿåœ¨ç¬¦å·åä¹‹åï¼Œè¡¨ç¤ºè¯¥å…¨å±€å˜é‡åªåœ¨å½“å‰æ–‡ä»¶ä¸­ç”Ÿæ•ˆï¼Œç±»ä¼¼äº C è¯­è¨€ä¸­çš„ staticã€‚å¦‚æœåœ¨å¦å¤–æ–‡ä»¶ä¸­å¼•ç”¨è¯¥å˜é‡çš„è¯ï¼Œä¼šæŠ¥ <code class="language-text">relocation target not found</code> çš„é”™è¯¯ã€‚</p>
<p>æœ¬å°èŠ‚ä¸­æåˆ°çš„ flagï¼Œè¿˜å¯ä»¥æœ‰å…¶å®ƒçš„å–å€¼:</p>
<blockquote>
<ul>
<li><code class="language-text">NOPROF</code>  = 1  </li>
</ul>
</blockquote>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(For  `TEXT`  items.) Don&#39;t profile the marked function. This flag is deprecated.</code></pre></div>
<blockquote>
<ul>
<li><code class="language-text">DUPOK</code>  = 2  </li>
</ul>
</blockquote>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">It is legal to have multiple instances of this symbol in a single binary. The linker will choose one of the duplicates to use.</code></pre></div>
<blockquote>
<ul>
<li><code class="language-text">NOSPLIT</code>  = 4  </li>
</ul>
</blockquote>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(For  `TEXT`  items.) Don&#39;t insert the preamble to check if the stack must be split. The frame for the routine, plus anything it calls, must fit in the spare space at the top of the stack segment. Used to protect routines such as the stack splitting code itself.</code></pre></div>
<blockquote>
<ul>
<li><code class="language-text">RODATA</code>  = 8  </li>
</ul>
</blockquote>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(For  `DATA`  and  `GLOBL`  items.) Put this data in a read-only section.</code></pre></div>
<blockquote>
<ul>
<li><code class="language-text">NOPTR</code>  = 16  </li>
</ul>
</blockquote>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(For  `DATA`  and  `GLOBL`  items.) This data contains no pointers and therefore does not need to be scanned by the garbage collector.</code></pre></div>
<blockquote>
<ul>
<li><code class="language-text">WRAPPER</code>  = 32  </li>
</ul>
</blockquote>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(For  `TEXT`  items.) This is a wrapper function and should not count as disabling  `recover`.</code></pre></div>
<blockquote>
<ul>
<li><code class="language-text">NEEDCTXT</code>  = 64  </li>
</ul>
</blockquote>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(For  `TEXT`  items.) This function is a closure so it uses its incoming context register.</code></pre></div>
<p>å½“ä½¿ç”¨è¿™äº› flag çš„å­—é¢é‡æ—¶ï¼Œéœ€è¦åœ¨æ±‡ç¼–æ–‡ä»¶ä¸­ <code class="language-text">#include &quot;textflag.h&quot;</code>ã€‚</p>
<h2 id="s-å’Œ-go-æ–‡ä»¶çš„å…¨å±€å˜é‡äº’é€š"><a href="#s-%E5%92%8C-go-%E6%96%87%E4%BB%B6%E7%9A%84%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E4%BA%92%E9%80%9A" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>.s å’Œ .go æ–‡ä»¶çš„å…¨å±€å˜é‡äº’é€š</h2>
<p>åœ¨ <code class="language-text">.s</code> æ–‡ä»¶ä¸­æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨ <code class="language-text">.go</code> ä¸­å®šä¹‰çš„å…¨å±€å˜é‡çš„ï¼Œçœ‹çœ‹ä¸‹é¢è¿™ä¸ªç®€å•çš„ä¾‹å­:</p>
<p>refer.go:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">999</span>
<span class="token keyword">func</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>refer.s:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">#include <span class="token string">"textflag.h"</span>

TEXT Â·<span class="token function">get</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> NOSPLIT<span class="token punctuation">,</span> $<span class="token number">0</span><span class="token operator">-</span><span class="token number">8</span>
    MOVQ Â·<span class="token function">a</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
    MOVQ AX<span class="token punctuation">,</span> ret<span class="token operator">+</span><span class="token function">0</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span>
    RET</code></pre></div>
<p>Â·a(SB)ï¼Œè¡¨ç¤ºè¯¥ç¬¦å·éœ€è¦é“¾æ¥å™¨æ¥å¸®æˆ‘ä»¬è¿›è¡Œé‡å®šå‘(relocation)ï¼Œå¦‚æœæ‰¾ä¸åˆ°è¯¥ç¬¦å·ï¼Œä¼šè¾“å‡º <code class="language-text">relocation target not found</code> çš„é”™è¯¯ã€‚</p>
<p>ä¾‹å­æ¯”è¾ƒç®€å•ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œå°è¯•ã€‚</p>
<h2 id="å‡½æ•°å£°æ˜"><a href="#%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>å‡½æ•°å£°æ˜</h2>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹ä¸€ä¸ªå…¸å‹çš„ plan9 çš„æ±‡ç¼–å‡½æ•°çš„å®šä¹‰ï¼š</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token comment">// func add(a, b int) int</span>
<span class="token comment">//   => è¯¥å£°æ˜å®šä¹‰åœ¨åŒä¸€ä¸ª package ä¸‹çš„ä»»æ„ .go æ–‡ä»¶ä¸­</span>
<span class="token comment">//   => åªæœ‰å‡½æ•°å¤´ï¼Œæ²¡æœ‰å®ç°</span>
TEXT pkgnameÂ·<span class="token function">add</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> NOSPLIT<span class="token punctuation">,</span> $<span class="token number">0</span><span class="token operator">-</span><span class="token number">8</span>
    MOVQ a<span class="token operator">+</span><span class="token function">0</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
    MOVQ a<span class="token operator">+</span><span class="token function">8</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> BX
    ADDQ AX<span class="token punctuation">,</span> BX
    MOVQ BX<span class="token punctuation">,</span> ret<span class="token operator">+</span><span class="token function">16</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span>
    RET</code></pre></div>
<p>ä¸ºä»€ä¹ˆè¦å« TEXT ï¼Ÿå¦‚æœå¯¹ç¨‹åºæ•°æ®åœ¨æ–‡ä»¶ä¸­å’Œå†…å­˜ä¸­çš„åˆ†æ®µç¨æœ‰äº†è§£çš„åŒå­¦åº”è¯¥çŸ¥é“ï¼Œæˆ‘ä»¬çš„ä»£ç åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œæ˜¯å­˜å‚¨åœ¨ .text æ®µä¸­çš„ï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯ä¸€ç§çº¦å®šä¿—æˆçš„èµ·åæ–¹å¼ã€‚å®é™…ä¸Šåœ¨ plan9 ä¸­ TEXT æ˜¯ä¸€ä¸ªæŒ‡ä»¤ï¼Œç”¨æ¥å®šä¹‰ä¸€ä¸ªå‡½æ•°ã€‚é™¤äº† TEXT ä¹‹å¤–è¿˜æœ‰å‰é¢å˜é‡å£°æ˜è¯´åˆ°çš„ DATA/GLOBLã€‚</p>
<p>å®šä¹‰ä¸­çš„ pkgname éƒ¨åˆ†æ˜¯å¯ä»¥çœç•¥çš„ï¼Œéæƒ³å†™ä¹Ÿå¯ä»¥å†™ä¸Šã€‚ä¸è¿‡å†™ä¸Š pkgname çš„è¯ï¼Œåœ¨é‡å‘½å package ä¹‹åè¿˜éœ€è¦æ”¹ä»£ç ï¼Œæ‰€ä»¥æ¨èæœ€å¥½è¿˜æ˜¯ä¸è¦å†™ã€‚</p>
<p>ä¸­ç‚¹ <code class="language-text">Â·</code> æ¯”è¾ƒç‰¹æ®Šï¼Œæ˜¯ä¸€ä¸ª unicode çš„ä¸­ç‚¹ï¼Œè¯¥ç‚¹åœ¨ mac ä¸‹çš„è¾“å…¥æ–¹æ³•æ˜¯ <code class="language-text">option+shift+9</code>ã€‚åœ¨ç¨‹åºè¢«é“¾æ¥ä¹‹åï¼Œæ‰€æœ‰çš„ä¸­ç‚¹<code class="language-text">Â·</code> éƒ½ä¼šè¢«æ›¿æ¢ä¸ºå¥å·<code class="language-text">.</code>ï¼Œæ¯”å¦‚ä½ çš„æ–¹æ³•æ˜¯ <code class="language-text">runtimeÂ·main</code>ï¼Œåœ¨ç¼–è¯‘ä¹‹åçš„ç¨‹åºé‡Œçš„ç¬¦å·åˆ™æ˜¯ <code class="language-text">runtime.main</code>ã€‚å—¯ï¼Œçœ‹èµ·æ¥å¾ˆå˜æ€ã€‚ç®€å•æ€»ç»“ä¸€ä¸‹:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">                              å‚æ•°åŠè¿”å›å€¼å¤§å°
                                  <span class="token operator">|</span> 
 TEXT pkgnameÂ·<span class="token function">add</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span>NOSPLIT<span class="token punctuation">,</span>$<span class="token number">32</span><span class="token operator">-</span><span class="token number">32</span>
       <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span>
      åŒ…å     å‡½æ•°å         æ ˆå¸§å¤§å°<span class="token punctuation">(</span>å±€éƒ¨å˜é‡<span class="token operator">+</span>å¯èƒ½éœ€è¦çš„é¢å¤–è°ƒç”¨å‡½æ•°çš„å‚æ•°ç©ºé—´çš„æ€»å¤§å°ï¼Œä½†ä¸åŒ…æ‹¬è°ƒç”¨å…¶å®ƒå‡½æ•°æ—¶çš„ ret address çš„å¤§å°<span class="token punctuation">)</span></code></pre></div>
<h2 id="æ ˆç»“æ„"><a href="#%E6%A0%88%E7%BB%93%E6%9E%84" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>æ ˆç»“æ„</h2>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªå…¸å‹çš„å‡½æ•°çš„æ ˆç»“æ„å›¾:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">                                                                                   
                       -----------------                                           
                       current func arg0                                           
                       ----------------- &lt;----------- FP(pseudo FP)                
                        caller ret addr                                            
                       +---------------+                                           
                       | caller BP(*)  |                                           
                       ----------------- &lt;----------- SP(pseudo SPï¼Œå®é™…ä¸Šæ˜¯å½“å‰æ ˆå¸§çš„ BP ä½ç½®)
                       |   Local Var0  |                                           
                       -----------------                                           
                       |   Local Var1  |                                           
                       -----------------                                           
                       |   Local Var2  |                                           
                       -----------------                -                          
                       |   ........    |                                           
                       -----------------                                           
                       |   Local VarN  |                                           
                       -----------------                                           
                       |               |                                           
                       |               |                                           
                       |  temporarily  |                                           
                       |  unused space |                                           
                       |               |                                           
                       |               |                                           
                       -----------------                                           
                       |  call retn    |                                           
                       -----------------                                           
                       |  call ret(n-1)|                                           
                       -----------------                                           
                       |  ..........   |                                           
                       -----------------                                           
                       |  call ret1    |                                           
                       -----------------                                           
                       |  call argn    |                                           
                       -----------------                                           
                       |   .....       |                                           
                       -----------------                                           
                       |  call arg3    |                                           
                       -----------------                                           
                       |  call arg2    |                                           
                       |---------------|                                           
                       |  call arg1    |                                           
                       -----------------   &lt;------------  hardware SP ä½ç½®           
                         return addr                                               
                       +---------------+                                           
                                                                                   </code></pre></div>
<p>ä»åŸç†ä¸Šæ¥è®²ï¼Œå¦‚æœå½“å‰å‡½æ•°è°ƒç”¨äº†å…¶å®ƒå‡½æ•°ï¼Œé‚£ä¹ˆ return addr ä¹Ÿæ˜¯åœ¨ caller çš„æ ˆä¸Šçš„ï¼Œä¸è¿‡å¾€æ ˆä¸Šæ’ return addr çš„è¿‡ç¨‹æ˜¯ç”± CALL æŒ‡ä»¤å®Œæˆçš„ï¼Œåœ¨ RET æ—¶ï¼ŒSP åˆä¼šæ¢å¤åˆ°å›¾ä¸Šä½ç½®ã€‚æˆ‘ä»¬åœ¨è®¡ç®— SP å’Œå‚æ•°ç›¸å¯¹ä½ç½®æ—¶ï¼Œå¯ä»¥è®¤ä¸ºç¡¬ä»¶ SP æŒ‡å‘çš„å°±æ˜¯å›¾ä¸Šçš„ä½ç½®ã€‚</p>
<p>å›¾ä¸Šçš„ caller BPï¼ŒæŒ‡çš„æ˜¯ caller çš„ BP å¯„å­˜å™¨å€¼ï¼Œæœ‰äº›äººæŠŠ caller BP å«ä½œ caller çš„ frame pointerï¼Œå®é™…ä¸Šè¿™ä¸ªä¹ æƒ¯æ˜¯ä» x86 æ¶æ„æ²¿è¢­æ¥çš„ã€‚Go çš„ asm æ–‡æ¡£ä¸­æŠŠä¼ªå¯„å­˜å™¨ FP ä¹Ÿç§°ä¸º frame pointerï¼Œä½†æ˜¯è¿™ä¸¤ä¸ª frame pointer æ ¹æœ¬ä¸æ˜¯ä¸€å›äº‹ã€‚</p>
<p>æ­¤å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œcaller BP æ˜¯åœ¨ç¼–è¯‘æœŸç”±ç¼–è¯‘å™¨æ’å…¥çš„ï¼Œç”¨æˆ·æ‰‹å†™ä»£ç æ—¶ï¼Œè®¡ç®— frame size æ—¶æ˜¯ä¸åŒ…æ‹¬è¿™ä¸ª caller BP éƒ¨åˆ†çš„ã€‚æ˜¯å¦æ’å…¥ caller BP çš„ä¸»è¦åˆ¤æ–­ä¾æ®æ˜¯:</p>
<ol>
<li>å‡½æ•°çš„æ ˆå¸§å¤§å°å¤§äº 0</li>
<li>ä¸‹è¿°å‡½æ•°è¿”å› true</li>
</ol>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">Framepointer_enabled</span><span class="token punctuation">(</span>goos<span class="token punctuation">,</span> goarch <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> framepointer_enabled <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> goarch <span class="token operator">==</span> <span class="token string">"amd64"</span> <span class="token operator">&amp;&amp;</span> goos <span class="token operator">!=</span> <span class="token string">"nacl"</span>
<span class="token punctuation">}</span></code></pre></div>
<p>å¦‚æœç¼–è¯‘å™¨åœ¨æœ€ç»ˆçš„æ±‡ç¼–ç»“æœä¸­æ²¡æœ‰æ’å…¥ caller BP(æºä»£ç ä¸­æ‰€ç§°çš„ frame pointer)çš„æƒ…å†µä¸‹ï¼Œä¼ª SP å’Œä¼ª FP ä¹‹é—´åªæœ‰ 8 ä¸ªå­—èŠ‚çš„ caller çš„ return addressï¼Œè€Œæ’å…¥äº† BP çš„è¯ï¼Œå°±ä¼šå¤šå‡ºé¢å¤–çš„ 8 å­—èŠ‚ã€‚ä¹Ÿå°±è¯´ä¼ª SP å’Œä¼ª FP çš„ç›¸å¯¹ä½ç½®æ˜¯ä¸å›ºå®šçš„ï¼Œæœ‰å¯èƒ½æ˜¯é—´éš” 8 ä¸ªå­—èŠ‚ï¼Œä¹Ÿæœ‰å¯èƒ½é—´éš” 16 ä¸ªå­—èŠ‚ã€‚å¹¶ä¸”åˆ¤æ–­ä¾æ®ä¼šæ ¹æ®å¹³å°å’Œ Go çš„ç‰ˆæœ¬æœ‰æ‰€ä¸åŒã€‚</p>
<p>å›¾ä¸Šå¯ä»¥çœ‹åˆ°ï¼ŒFP ä¼ªå¯„å­˜å™¨æŒ‡å‘å‡½æ•°çš„ä¼ å…¥å‚æ•°çš„å¼€å§‹ä½ç½®ï¼Œå› ä¸ºæ ˆæ˜¯æœä½åœ°å€æ–¹å‘å¢é•¿ï¼Œä¸ºäº†é€šè¿‡å¯„å­˜å™¨å¼•ç”¨å‚æ•°æ—¶æ–¹ä¾¿ï¼Œæ‰€ä»¥å‚æ•°çš„æ‘†æ”¾æ–¹å‘å’Œæ ˆçš„å¢é•¿æ–¹å‘æ˜¯ç›¸åçš„ï¼Œå³ï¼š</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">                              FP
high ----------------------<span class="token operator">></span> low
argN, <span class="token punctuation">..</span>. arg3, arg2, arg1, arg0</code></pre></div>
<p>å‡è®¾æ‰€æœ‰å‚æ•°å‡ä¸º 8 å­—èŠ‚ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç”¨ symname+0(FP) è®¿é—®ç¬¬ä¸€ä¸ª å‚æ•°ï¼Œsymname+8(FP) è®¿é—®ç¬¬äºŒä¸ªå‚æ•°ï¼Œä»¥æ­¤ç±»æ¨ã€‚ç”¨ä¼ª SP æ¥å¼•ç”¨å±€éƒ¨å˜é‡ï¼ŒåŸç†ä¸Šæ¥è®²å·®ä¸å¤šï¼Œä¸è¿‡å› ä¸ºä¼ª SP æŒ‡å‘çš„æ˜¯å±€éƒ¨å˜é‡çš„åº•éƒ¨ï¼Œæ‰€ä»¥ symname-8(SP) è¡¨ç¤ºçš„æ˜¯ç¬¬ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œsymname-16(SP)è¡¨ç¤ºç¬¬äºŒä¸ªï¼Œä»¥æ­¤ç±»æ¨ã€‚å½“ç„¶ï¼Œè¿™é‡Œå‡è®¾å±€éƒ¨å˜é‡éƒ½å ç”¨ 8 ä¸ªå­—èŠ‚ã€‚</p>
<p>å›¾çš„æœ€ä¸Šéƒ¨çš„ caller return address å’Œ current func arg0 éƒ½æ˜¯ç”± caller æ¥åˆ†é…ç©ºé—´çš„ã€‚ä¸ç®—åœ¨å½“å‰çš„æ ˆå¸§å†…ã€‚</p>
<p>å› ä¸ºå®˜æ–¹æ–‡æ¡£æœ¬èº«è¾ƒæ¨¡ç³Šï¼Œæˆ‘ä»¬æ¥ä¸€ä¸ªå‡½æ•°è°ƒç”¨çš„å…¨æ™¯å›¾ï¼Œæ¥çœ‹ä¸€ä¸‹è¿™äº›çœŸå‡ SP/FP/BP åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆå…³ç³»:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">                                                                                                                              
                                       caller                                                                                 
                                 +------------------+                                                                         
                                 |                  |                                                                         
       +----------------------&gt;  --------------------                                                                         
       |                         |                  |                                                                         
       |                         | caller parent BP |                                                                         
       |           BP(pseudo SP) --------------------                                                                         
       |                         |                  |                                                                         
       |                         |   Local Var0     |                                                                         
       |                         --------------------                                                                         
       |                         |                  |                                                                         
       |                         |   .......        |                                                                         
       |                         --------------------                                                                         
       |                         |                  |                                                                         
       |                         |   Local VarN     |                                                                         
                                 --------------------                                                                         
 caller stack frame              |                  |                                                                         
                                 |   callee arg2    |                                                                         
       |                         |------------------|                                                                         
       |                         |                  |                                                                         
       |                         |   callee arg1    |                                                                         
       |                         |------------------|                                                                         
       |                         |                  |                                                                         
       |                         |   callee arg0    |                                                                         
       |                         ----------------------------------------------+   FP(virtual register)                       
       |                         |                  |                          |                                              
       |                         |   return addr    |  parent return address   |                                              
       +----------------------&gt;  +------------------+---------------------------    &lt;-------------------------------+         
                                                    |  caller BP               |                                    |         
                                                    |  (caller frame pointer)  |                                    |         
                                     BP(pseudo SP)  ----------------------------                                    |         
                                                    |                          |                                    |         
                                                    |     Local Var0           |                                    |         
                                                    ----------------------------                                    |         
                                                    |                          |                                              
                                                    |     Local Var1           |                                              
                                                    ----------------------------                            callee stack frame
                                                    |                          |                                              
                                                    |       .....              |                                              
                                                    ----------------------------                                    |         
                                                    |                          |                                    |         
                                                    |     Local VarN           |                                    |         
                                  SP(Real Register) ----------------------------                                    |         
                                                    |                          |                                    |         
                                                    |                          |                                    |         
                                                    |                          |                                    |         
                                                    |                          |                                    |         
                                                    |                          |                                    |         
                                                    +--------------------------+    &lt;-------------------------------+         
                                                                                                                              
                                                              callee</code></pre></div>
<h2 id="argsize-å’Œ-framesize-è®¡ç®—è§„åˆ™"><a href="#argsize-%E5%92%8C-framesize-%E8%AE%A1%E7%AE%97%E8%A7%84%E5%88%99" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>argsize å’Œ framesize è®¡ç®—è§„åˆ™</h2>
<h3 id="argsize"><a href="#argsize" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>argsize</h3>
<p>åœ¨å‡½æ•°å£°æ˜ä¸­:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"> TEXT pkgnameÂ·<span class="token function">add</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span>NOSPLIT<span class="token punctuation">,</span>$<span class="token number">16</span><span class="token operator">-</span><span class="token number">32</span></code></pre></div>
<p>å‰é¢å·²ç»è¯´è¿‡ $16-32 è¡¨ç¤º $framesize-argsizeã€‚Go åœ¨å‡½æ•°è°ƒç”¨æ—¶ï¼Œå‚æ•°å’Œè¿”å›å€¼éƒ½éœ€è¦ç”± caller åœ¨å…¶æ ˆå¸§ä¸Šå¤‡å¥½ç©ºé—´ã€‚callee åœ¨å£°æ˜æ—¶ä»ç„¶éœ€è¦çŸ¥é“è¿™ä¸ª argsizeã€‚argsize çš„è®¡ç®—æ–¹æ³•æ˜¯ï¼Œå‚æ•°å¤§å°æ±‚å’Œ+è¿”å›å€¼å¤§å°æ±‚å’Œï¼Œä¾‹å¦‚å…¥å‚æ˜¯ 3 ä¸ª int64 ç±»å‹ï¼Œè¿”å›å€¼æ˜¯ 1 ä¸ª int64 ç±»å‹ï¼Œé‚£ä¹ˆè¿™é‡Œçš„ argsize =  sizeof(int64) * 4ã€‚</p>
<p>ä¸è¿‡çœŸå®ä¸–ç•Œæ°¸è¿œæ²¡æœ‰æˆ‘ä»¬å‡è®¾çš„è¿™ä¹ˆç¾å¥½ï¼Œå‡½æ•°å‚æ•°å¾€å¾€æ··åˆäº†å¤šç§ç±»å‹ï¼Œè¿˜éœ€è¦è€ƒè™‘å†…å­˜å¯¹é½é—®é¢˜ã€‚</p>
<p>å¦‚æœä¸ç¡®å®šè‡ªå·±çš„å‡½æ•°ç­¾åéœ€è¦å¤šå¤§çš„ argsizeï¼Œå¯ä»¥é€šè¿‡ç®€å•å®ç°ä¸€ä¸ªç›¸åŒç­¾åçš„ç©ºå‡½æ•°ï¼Œç„¶å go tool objdump æ¥é€†å‘æŸ¥æ‰¾åº”è¯¥åˆ†é…å¤šå°‘ç©ºé—´ã€‚</p>
<h3 id="framesize"><a href="#framesize" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>framesize</h3>
<p>å‡½æ•°çš„ framesize å°±ç¨å¾®å¤æ‚ä¸€äº›äº†ï¼Œæ‰‹å†™ä»£ç çš„ framesize ä¸éœ€è¦è€ƒè™‘ç”±ç¼–è¯‘å™¨æ’å…¥çš„ caller BPï¼Œè¦è€ƒè™‘ï¼š</p>
<ol>
<li>å±€éƒ¨å˜é‡ï¼ŒåŠå…¶æ¯ä¸ªå˜é‡çš„ sizeã€‚</li>
<li>åœ¨å‡½æ•°ä¸­æ˜¯å¦æœ‰å¯¹å…¶å®ƒå‡½æ•°è°ƒç”¨æ—¶ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œè°ƒç”¨æ—¶éœ€è¦å°† callee çš„å‚æ•°ã€è¿”å›å€¼è€ƒè™‘åœ¨å†…ã€‚è™½ç„¶ return address(rip)çš„å€¼ä¹Ÿæ˜¯å­˜å‚¨åœ¨ caller çš„ stack frame ä¸Šçš„ï¼Œä½†æ˜¯è¿™ä¸ªè¿‡ç¨‹æ˜¯ç”± CALL æŒ‡ä»¤å’Œ RET æŒ‡ä»¤å®Œæˆ PC å¯„å­˜å™¨çš„ä¿å­˜å’Œæ¢å¤çš„ï¼Œåœ¨æ‰‹å†™æ±‡ç¼–æ—¶ï¼ŒåŒæ ·ä¹Ÿæ˜¯ä¸éœ€è¦è€ƒè™‘è¿™ä¸ª PC å¯„å­˜å™¨åœ¨æ ˆä¸Šæ‰€éœ€å ç”¨çš„ 8 ä¸ªå­—èŠ‚çš„ã€‚</li>
<li>åŸåˆ™ä¸Šæ¥è¯´ï¼Œè°ƒç”¨å‡½æ•°æ—¶åªè¦ä¸æŠŠå±€éƒ¨å˜é‡è¦†ç›–æ‰å°±å¯ä»¥äº†ã€‚ç¨å¾®å¤šåˆ†é…å‡ ä¸ªå­—èŠ‚çš„ framesize ä¹Ÿä¸ä¼šæ­»ã€‚</li>
<li>åœ¨ç¡®ä¿é€»è¾‘æ²¡æœ‰é—®é¢˜çš„å‰æä¸‹ï¼Œä½ æ„¿æ„è¦†ç›–å±€éƒ¨å˜é‡ä¹Ÿæ²¡æœ‰é—®é¢˜ã€‚åªè¦ä¿è¯è¿›å…¥å’Œé€€å‡ºæ±‡ç¼–å‡½æ•°æ—¶çš„ caller å’Œ callee èƒ½æ­£ç¡®æ‹¿åˆ°è¿”å›å€¼å°±å¯ä»¥ã€‚</li>
</ol>
<h2 id="åœ°å€è¿ç®—"><a href="#%E5%9C%B0%E5%9D%80%E8%BF%90%E7%AE%97" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>åœ°å€è¿ç®—</h2>
<p>åœ°å€è¿ç®—ä¹Ÿæ˜¯ç”¨ lea æŒ‡ä»¤ï¼Œè‹±æ–‡åŸæ„ä¸º <code class="language-text">Load Effective Address</code>ï¼Œamd64 å¹³å°åœ°å€éƒ½æ˜¯ 8 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥ç›´æ¥å°±ç”¨ LEAQ å°±å¥½:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">LEAQ <span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">(</span>AX<span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CX
<span class="token comment">// ä¸Šé¢ä»£ç ä¸­çš„ 8 ä»£è¡¨ scale</span>
<span class="token comment">// scale åªèƒ½æ˜¯ 0ã€2ã€4ã€8</span>
<span class="token comment">// å¦‚æœå†™æˆå…¶å®ƒå€¼:</span>
<span class="token comment">// LEAQ (BX)(AX*3), CX</span>
<span class="token comment">// ./a.s:6: bad scale: 3</span>

<span class="token comment">// ç”¨ LEAQ çš„è¯ï¼Œå³ä½¿æ˜¯ä¸¤ä¸ªå¯„å­˜å™¨å€¼ç›´æ¥ç›¸åŠ ï¼Œä¹Ÿå¿…é¡»æä¾› scale</span>
<span class="token comment">// ä¸‹é¢è¿™æ ·æ˜¯ä¸è¡Œçš„</span>
<span class="token comment">// LEAQ (BX)(AX), CX</span>
<span class="token comment">// asm: asmidx: bad address 0/2064/2067</span>
<span class="token comment">// æ­£ç¡®çš„å†™æ³•æ˜¯</span>
LEAQ <span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">(</span>AX<span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CX


<span class="token comment">// åœ¨å¯„å­˜å™¨è¿ç®—çš„åŸºç¡€ä¸Šï¼Œå¯ä»¥åŠ ä¸Šé¢å¤–çš„ offset</span>
LEAQ <span class="token function">16</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">(</span>AX<span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CX

<span class="token comment">// ä¸‰ä¸ªå¯„å­˜å™¨åšè¿ç®—ï¼Œè¿˜æ˜¯åˆ«æƒ³äº†</span>
<span class="token comment">// LEAQ DX(BX)(AX*8), CX</span>
<span class="token comment">// ./a.s:13: expected end of operand, found (</span></code></pre></div>
<p>ä½¿ç”¨ LEAQ çš„å¥½å¤„ä¹Ÿæ¯”è¾ƒæ˜æ˜¾ï¼Œå¯ä»¥èŠ‚çœæŒ‡ä»¤æ•°ã€‚å¦‚æœç”¨åŸºæœ¬ç®—æœ¯æŒ‡ä»¤æ¥å®ç° LEAQ çš„åŠŸèƒ½ï¼Œéœ€è¦ä¸¤~ä¸‰æ¡ä»¥ä¸Šçš„è®¡ç®—æŒ‡ä»¤æ‰èƒ½å®ç° LEAQ çš„å®Œæ•´åŠŸèƒ½ã€‚</p>
<h2 id="ç¤ºä¾‹"><a href="#%E7%A4%BA%E4%BE%8B" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ç¤ºä¾‹</h2>
<h3 id="addsubmul"><a href="#addsubmul" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>add/sub/mul</h3>
<p>math.go:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token comment">// æ±‡ç¼–å‡½æ•°å£°æ˜</span>

<span class="token keyword">func</span> <span class="token function">sub</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token comment">// æ±‡ç¼–å‡½æ•°å£°æ˜</span>

<span class="token keyword">func</span> <span class="token function">mul</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token comment">// æ±‡ç¼–å‡½æ•°å£°æ˜</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>math.s:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">#include <span class="token string">"textflag.h"</span> <span class="token comment">// å› ä¸ºæˆ‘ä»¬å£°æ˜å‡½æ•°ç”¨åˆ°äº† NOSPLIT è¿™æ ·çš„ flagï¼Œæ‰€ä»¥éœ€è¦å°† textflag.h åŒ…å«è¿›æ¥</span>

<span class="token comment">// func add(a, b int) int</span>
TEXT Â·<span class="token function">add</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> NOSPLIT<span class="token punctuation">,</span> $<span class="token number">0</span><span class="token operator">-</span><span class="token number">24</span>
    MOVQ a<span class="token operator">+</span><span class="token function">0</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> AX <span class="token comment">// å‚æ•° a</span>
    MOVQ b<span class="token operator">+</span><span class="token function">8</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> BX <span class="token comment">// å‚æ•° b</span>
    ADDQ BX<span class="token punctuation">,</span> AX    <span class="token comment">// AX += BX</span>
    MOVQ AX<span class="token punctuation">,</span> ret<span class="token operator">+</span><span class="token function">16</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span> <span class="token comment">// è¿”å›</span>
    RET

<span class="token comment">// func sub(a, b int) int</span>
TEXT Â·<span class="token function">sub</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> NOSPLIT<span class="token punctuation">,</span> $<span class="token number">0</span><span class="token operator">-</span><span class="token number">24</span>
    MOVQ a<span class="token operator">+</span><span class="token function">0</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
    MOVQ b<span class="token operator">+</span><span class="token function">8</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> BX
    SUBQ BX<span class="token punctuation">,</span> AX    <span class="token comment">// AX -= BX</span>
    MOVQ AX<span class="token punctuation">,</span> ret<span class="token operator">+</span><span class="token function">16</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span>
    RET

<span class="token comment">// func mul(a, b int) int</span>
TEXT Â·<span class="token function">mul</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> NOSPLIT<span class="token punctuation">,</span> $<span class="token number">0</span><span class="token operator">-</span><span class="token number">24</span>
    MOVQ  a<span class="token operator">+</span><span class="token function">0</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
    MOVQ  b<span class="token operator">+</span><span class="token function">8</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> BX
    IMULQ BX<span class="token punctuation">,</span> AX    <span class="token comment">// AX *= BX</span>
    MOVQ  AX<span class="token punctuation">,</span> ret<span class="token operator">+</span><span class="token function">16</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span>
    RET
    <span class="token comment">// æœ€åä¸€è¡Œçš„ç©ºè¡Œæ˜¯å¿…é¡»çš„ï¼Œå¦åˆ™å¯èƒ½æŠ¥ unexpected EOF</span></code></pre></div>
<p>æŠŠè¿™ä¸¤ä¸ªæ–‡ä»¶æ”¾åœ¨ä»»æ„ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ <code class="language-text">go build</code> å¹¶è¿è¡Œå°±å¯ä»¥çœ‹åˆ°æ•ˆæœäº†ã€‚</p>
<h3 id="ä¼ªå¯„å­˜å™¨-sp-ã€ä¼ªå¯„å­˜å™¨-fp-å’Œç¡¬ä»¶å¯„å­˜å™¨-sp"><a href="#%E4%BC%AA%E5%AF%84%E5%AD%98%E5%99%A8-sp-%E3%80%81%E4%BC%AA%E5%AF%84%E5%AD%98%E5%99%A8-fp-%E5%92%8C%E7%A1%AC%E4%BB%B6%E5%AF%84%E5%AD%98%E5%99%A8-sp" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ä¼ªå¯„å­˜å™¨ SP ã€ä¼ªå¯„å­˜å™¨ FP å’Œç¡¬ä»¶å¯„å­˜å™¨ SP</h3>
<p>æ¥å†™ä¸€æ®µç®€å•çš„ä»£ç è¯æ˜ä¼ª SPã€ä¼ª FP å’Œç¡¬ä»¶ SP çš„ä½ç½®å…³ç³»ã€‚
spspfp.s:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">#include <span class="token string">"textflag.h"</span>

<span class="token comment">// func output(int) (int, int, int)</span>
TEXT Â·<span class="token function">output</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> $<span class="token number">8</span><span class="token operator">-</span><span class="token number">48</span>
    MOVQ <span class="token function">24</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span><span class="token punctuation">,</span> DX <span class="token comment">// ä¸å¸¦ symbolï¼Œè¿™é‡Œçš„ SP æ˜¯ç¡¬ä»¶å¯„å­˜å™¨ SP</span>
    MOVQ DX<span class="token punctuation">,</span> ret3<span class="token operator">+</span><span class="token function">24</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span> <span class="token comment">// ç¬¬ä¸‰ä¸ªè¿”å›å€¼</span>
    MOVQ perhapsArg1<span class="token operator">+</span><span class="token function">16</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span><span class="token punctuation">,</span> BX <span class="token comment">// å½“å‰å‡½æ•°æ ˆå¤§å° > 0ï¼Œæ‰€ä»¥ FP åœ¨ SP çš„ä¸Šæ–¹ 16 å­—èŠ‚å¤„</span>
    MOVQ BX<span class="token punctuation">,</span> ret2<span class="token operator">+</span><span class="token function">16</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span> <span class="token comment">// ç¬¬äºŒä¸ªè¿”å›å€¼</span>
    MOVQ arg1<span class="token operator">+</span><span class="token function">0</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
    MOVQ AX<span class="token punctuation">,</span> ret1<span class="token operator">+</span><span class="token function">8</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span>  <span class="token comment">// ç¬¬ä¸€ä¸ªè¿”å›å€¼</span>
    RET</code></pre></div>
<p>spspfp.go:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">output</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// æ±‡ç¼–å‡½æ•°å£°æ˜</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token function">output</span><span class="token punctuation">(</span><span class="token number">987654321</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>æ‰§è¡Œä¸Šé¢çš„ä»£ç ï¼Œå¯ä»¥å¾—åˆ°è¾“å‡º:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell"><span class="token number">987654321</span> <span class="token number">987654321</span> <span class="token number">987654321</span></code></pre></div>
<p>å’Œä»£ç ç»“åˆæ€è€ƒï¼Œå¯ä»¥çŸ¥é“æˆ‘ä»¬å½“å‰çš„æ ˆç»“æ„æ˜¯è¿™æ ·çš„:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">------
ret2 <span class="token punctuation">(</span><span class="token number">8</span> bytes<span class="token punctuation">)</span>
------
ret1 <span class="token punctuation">(</span><span class="token number">8</span> bytes<span class="token punctuation">)</span>
------
ret0 <span class="token punctuation">(</span><span class="token number">8</span> bytes<span class="token punctuation">)</span>
------
arg0 <span class="token punctuation">(</span><span class="token number">8</span> bytes<span class="token punctuation">)</span>
------ FP
ret addr <span class="token punctuation">(</span><span class="token number">8</span> bytes<span class="token punctuation">)</span>
------
<span class="token builtin class-name">caller</span> BP <span class="token punctuation">(</span><span class="token number">8</span> bytes<span class="token punctuation">)</span>
------ pseudo SP
frame content <span class="token punctuation">(</span><span class="token number">8</span> bytes<span class="token punctuation">)</span>
------ hardware SP</code></pre></div>
<p>æœ¬å°èŠ‚ä¾‹å­çš„ framesize æ˜¯å¤§äº 0 çš„ï¼Œè¯»è€…å¯ä»¥å°è¯•ä¿®æ”¹ framesize ä¸º 0ï¼Œç„¶åè°ƒæ•´ä»£ç ä¸­å¼•ç”¨ä¼ª SP å’Œç¡¬ä»¶ SP æ—¶çš„ offsetï¼Œæ¥ç ”ç©¶ framesize ä¸º 0 æ—¶ï¼Œä¼ª FPï¼Œä¼ª SP å’Œç¡¬ä»¶ SP ä¸‰è€…ä¹‹é—´çš„ç›¸å¯¹ä½ç½®ã€‚</p>
<p>æœ¬å°èŠ‚çš„ä¾‹å­æ˜¯ä¸ºäº†å‘Šè¯‰å¤§å®¶ï¼Œä¼ª SP å’Œä¼ª FP çš„ç›¸å¯¹ä½ç½®æ˜¯ä¼šå˜åŒ–çš„ï¼Œæ‰‹å†™æ—¶ä¸åº”è¯¥ç”¨ä¼ª SP å’Œ >0 çš„ offset æ¥å¼•ç”¨æ•°æ®ï¼Œå¦åˆ™ç»“æœå¯èƒ½ä¼šå‡ºä¹ä½ çš„é¢„æ–™ã€‚</p>
<h3 id="æ±‡ç¼–è°ƒç”¨éæ±‡ç¼–å‡½æ•°"><a href="#%E6%B1%87%E7%BC%96%E8%B0%83%E7%94%A8%E9%9D%9E%E6%B1%87%E7%BC%96%E5%87%BD%E6%95%B0" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>æ±‡ç¼–è°ƒç”¨éæ±‡ç¼–å‡½æ•°</h3>
<p>output.s:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">#include <span class="token string">"textflag.h"</span>

<span class="token comment">// func output(a,b int) int</span>
TEXT Â·<span class="token function">output</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> NOSPLIT<span class="token punctuation">,</span> $<span class="token number">24</span><span class="token operator">-</span><span class="token number">24</span>
    MOVQ a<span class="token operator">+</span><span class="token function">0</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> DX <span class="token comment">// arg a</span>
    MOVQ DX<span class="token punctuation">,</span> <span class="token function">0</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span> <span class="token comment">// arg x</span>
    MOVQ b<span class="token operator">+</span><span class="token function">8</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> CX <span class="token comment">// arg b</span>
    MOVQ CX<span class="token punctuation">,</span> <span class="token function">8</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span> <span class="token comment">// arg y</span>
    CALL Â·<span class="token function">add</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span> <span class="token comment">// åœ¨è°ƒç”¨ add ä¹‹å‰ï¼Œå·²ç»æŠŠå‚æ•°éƒ½é€šè¿‡ç‰©ç†å¯„å­˜å™¨ SP æ¬åˆ°äº†å‡½æ•°çš„æ ˆé¡¶</span>
    MOVQ <span class="token function">16</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span><span class="token punctuation">,</span> AX <span class="token comment">// add å‡½æ•°ä¼šæŠŠè¿”å›å€¼æ”¾åœ¨è¿™ä¸ªä½ç½®</span>
    MOVQ AX<span class="token punctuation">,</span> ret<span class="token operator">+</span><span class="token function">16</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span> <span class="token comment">// return result</span>
    RET</code></pre></div>
<p>output.go:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> x <span class="token operator">+</span> y
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">output</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s <span class="token operator">:=</span> <span class="token function">output</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="æ±‡ç¼–ä¸­çš„å¾ªç¯"><a href="#%E6%B1%87%E7%BC%96%E4%B8%AD%E7%9A%84%E5%BE%AA%E7%8E%AF" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>æ±‡ç¼–ä¸­çš„å¾ªç¯</h3>
<p>é€šè¿‡ DECQ å’Œ JZ ç»“åˆï¼Œå¯ä»¥å®ç°é«˜çº§è¯­è¨€é‡Œçš„å¾ªç¯é€»è¾‘:</p>
<p>sum.s:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">#include <span class="token string">"textflag.h"</span>

<span class="token comment">// func sum(sl []int64) int64</span>
TEXT Â·<span class="token function">sum</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> NOSPLIT<span class="token punctuation">,</span> $<span class="token number">0</span><span class="token operator">-</span><span class="token number">32</span>
    MOVQ $<span class="token number">0</span><span class="token punctuation">,</span> SI
    MOVQ sl<span class="token operator">+</span><span class="token function">0</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> BX <span class="token comment">// &amp;sl[0], addr of the first elem</span>
    MOVQ sl<span class="token operator">+</span><span class="token function">8</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> CX <span class="token comment">// len(sl)</span>
    INCQ CX           <span class="token comment">// CX++, å› ä¸ºè¦å¾ªç¯ len æ¬¡</span>

start<span class="token punctuation">:</span>
    DECQ CX       <span class="token comment">// CX--</span>
    JZ   done
    ADDQ <span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">,</span> SI <span class="token comment">// SI += *BX</span>
    ADDQ $<span class="token number">8</span><span class="token punctuation">,</span> BX   <span class="token comment">// æŒ‡é’ˆç§»åŠ¨</span>
    JMP  start

done<span class="token punctuation">:</span>
    <span class="token comment">// è¿”å›åœ°å€æ˜¯ 24 æ˜¯æ€ä¹ˆå¾—æ¥çš„å‘¢ï¼Ÿ</span>
    <span class="token comment">// å¯ä»¥é€šè¿‡ go tool compile -S math.go å¾—çŸ¥</span>
    <span class="token comment">// åœ¨è°ƒç”¨ sum å‡½æ•°æ—¶ï¼Œä¼šä¼ å…¥ä¸‰ä¸ªå€¼ï¼Œåˆ†åˆ«ä¸º:</span>
    <span class="token comment">// slice çš„é¦–åœ°å€ã€slice çš„ lenï¼Œ slice çš„ cap</span>
    <span class="token comment">// ä¸è¿‡æˆ‘ä»¬è¿™é‡Œçš„æ±‚å’Œåªéœ€è¦ lenï¼Œä½† cap ä¾ç„¶ä¼šå ç”¨å‚æ•°çš„ç©ºé—´</span>
    <span class="token comment">// å°±æ˜¯ 16(FP)</span>
    MOVQ SI<span class="token punctuation">,</span> ret<span class="token operator">+</span><span class="token function">24</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span>
    RET</code></pre></div>
<p>sum.go:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h2 id="æ‰©å±•è¯é¢˜"><a href="#%E6%89%A9%E5%B1%95%E8%AF%9D%E9%A2%98" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>æ‰©å±•è¯é¢˜</h2>
<h3 id="æ ‡å‡†åº“ä¸­çš„ä¸€äº›æ•°æ®ç»“æ„"><a href="#%E6%A0%87%E5%87%86%E5%BA%93%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>æ ‡å‡†åº“ä¸­çš„ä¸€äº›æ•°æ®ç»“æ„</h3>
<h4 id="æ•°å€¼ç±»å‹"><a href="#%E6%95%B0%E5%80%BC%E7%B1%BB%E5%9E%8B" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>æ•°å€¼ç±»å‹</h4>
<p>æ ‡å‡†åº“ä¸­çš„æ•°å€¼ç±»å‹å¾ˆå¤š:</p>
<ol>
<li>int/int8/int16/int32/int64</li>
<li>uint/uint8/uint16/uint32/uint64</li>
<li>float32/float64</li>
<li>byte/rune</li>
<li>uintptr</li>
</ol>
<p>è¿™äº›ç±»å‹åœ¨æ±‡ç¼–ä¸­å°±æ˜¯ä¸€æ®µå­˜å‚¨ç€æ•°æ®çš„è¿ç»­å†…å­˜ï¼Œåªæ˜¯å†…å­˜é•¿åº¦ä¸ä¸€æ ·ï¼Œæ“ä½œçš„æ—¶å€™çœ‹å¥½æ•°æ®é•¿åº¦å°±è¡Œã€‚</p>
<h4 id="slice"><a href="#slice" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>slice</h4>
<p>å‰é¢çš„ä¾‹å­å·²ç»è¯´è¿‡äº†ï¼Œslice åœ¨ä¼ é€’ç»™å‡½æ•°çš„æ—¶å€™ï¼Œå®é™…ä¸Šä¼šå±•å¼€æˆä¸‰ä¸ªå‚æ•°:</p>
<ol>
<li>é¦–å…ƒç´ åœ°å€</li>
<li>slice çš„ len</li>
<li>slice çš„ cap</li>
</ol>
<p>åœ¨æ±‡ç¼–ä¸­å¤„ç†æ—¶ï¼Œåªè¦çŸ¥é“è¿™ä¸ªåŸåˆ™é‚£å°±å¾ˆå¥½åŠäº†ï¼ŒæŒ‰é¡ºåºè¿˜æ˜¯æŒ‰ç´¢å¼•æ“ä½œéšä½ å¼€å¿ƒã€‚</p>
<h4 id="string"><a href="#string" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>string</h4>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token comment">//go:noinline</span>
<span class="token keyword">func</span> <span class="token function">stringParam</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token string">"abcc"</span>
    <span class="token function">stringParam</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>ç”¨ <code class="language-text">go tool compile -S</code> è¾“å‡ºå…¶æ±‡ç¼–:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token number">0x001d</span> <span class="token number">00029</span> <span class="token punctuation">(</span>stringParam<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">)</span>    LEAQ    <span class="token keyword">go</span><span class="token punctuation">.</span><span class="token builtin">string</span><span class="token punctuation">.</span><span class="token string">"abcc"</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> AX  <span class="token comment">// è·å– RODATA æ®µä¸­çš„å­—ç¬¦ä¸²åœ°å€</span>
<span class="token number">0x0024</span> <span class="token number">00036</span> <span class="token punctuation">(</span>stringParam<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">)</span>    MOVQ    AX<span class="token punctuation">,</span> <span class="token punctuation">(</span>SP<span class="token punctuation">)</span> <span class="token comment">// å°†è·å–åˆ°çš„åœ°å€æ”¾åœ¨æ ˆé¡¶ï¼Œä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°</span>
<span class="token number">0x0028</span> <span class="token number">00040</span> <span class="token punctuation">(</span>stringParam<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">)</span>    MOVQ    $<span class="token number">4</span><span class="token punctuation">,</span> <span class="token function">8</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span> <span class="token comment">// å­—ç¬¦ä¸²é•¿åº¦ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°</span>
<span class="token number">0x0031</span> <span class="token number">00049</span> <span class="token punctuation">(</span>stringParam<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">)</span>    PCDATA  $<span class="token number">0</span><span class="token punctuation">,</span> $<span class="token number">0</span> <span class="token comment">// gc ç›¸å…³</span>
<span class="token number">0x0031</span> <span class="token number">00049</span> <span class="token punctuation">(</span>stringParam<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">)</span>    CALL    <span class="token string">""</span><span class="token punctuation">.</span><span class="token function">stringParam</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span> <span class="token comment">// è°ƒç”¨ stringParam å‡½æ•°</span></code></pre></div>
<p>åœ¨æ±‡ç¼–å±‚é¢ string å°±æ˜¯åœ°å€ + å­—ç¬¦ä¸²é•¿åº¦ã€‚</p>
<h4 id="struct"><a href="#struct" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>struct</h4>
<p>struct åœ¨æ±‡ç¼–å±‚é¢å®é™…ä¸Šå°±æ˜¯ä¸€æ®µè¿ç»­å†…å­˜ï¼Œåœ¨ä½œä¸ºå‚æ•°ä¼ ç»™å‡½æ•°æ—¶ï¼Œä¼šå°†å…¶å±•å¼€åœ¨ caller çš„æ ˆä¸Šä¼ ç»™å¯¹åº”çš„ callee:</p>
<p>struct.go</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">type</span> address <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    lng <span class="token builtin">int</span>
    lat <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> person <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    age    <span class="token builtin">int</span>
    height <span class="token builtin">int</span>
    addr   address
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">readStruct</span><span class="token punctuation">(</span>p person<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> p <span class="token operator">=</span> person<span class="token punctuation">{</span>
        age<span class="token punctuation">:</span>    <span class="token number">99</span><span class="token punctuation">,</span>
        height<span class="token punctuation">:</span> <span class="token number">88</span><span class="token punctuation">,</span>
        addr<span class="token punctuation">:</span> address<span class="token punctuation">{</span>
            lng<span class="token punctuation">:</span> <span class="token number">77</span><span class="token punctuation">,</span>
            lat<span class="token punctuation">:</span> <span class="token number">66</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d <span class="token operator">:=</span> <span class="token function">readStruct</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>struct.s</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">#include <span class="token string">"textflag.h"</span>

TEXT Â·<span class="token function">readStruct</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> NOSPLIT<span class="token punctuation">,</span> $<span class="token number">0</span><span class="token operator">-</span><span class="token number">64</span>
    MOVQ arg0<span class="token operator">+</span><span class="token function">0</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
    MOVQ AX<span class="token punctuation">,</span> ret0<span class="token operator">+</span><span class="token function">32</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span>
    MOVQ arg1<span class="token operator">+</span><span class="token function">8</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
    MOVQ AX<span class="token punctuation">,</span> ret1<span class="token operator">+</span><span class="token function">40</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span>
    MOVQ arg2<span class="token operator">+</span><span class="token function">16</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
    MOVQ AX<span class="token punctuation">,</span> ret2<span class="token operator">+</span><span class="token function">48</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span>
    MOVQ arg3<span class="token operator">+</span><span class="token function">24</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
    MOVQ AX<span class="token punctuation">,</span> ret3<span class="token operator">+</span><span class="token function">56</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span>
    RET</code></pre></div>
<p>ä¸Šè¿°çš„ç¨‹åºä¼šè¾“å‡º 99, 88, 77, 66ï¼Œè¿™è¡¨æ˜å³ä½¿æ˜¯å†…åµŒç»“æ„ä½“ï¼Œåœ¨å†…å­˜åˆ†å¸ƒä¸Šä¾ç„¶æ˜¯è¿ç»­çš„ã€‚</p>
<h4 id="map"><a href="#map" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>map</h4>
<p>é€šè¿‡å¯¹ä¸‹è¿°æ–‡ä»¶è¿›è¡Œæ±‡ç¼–(go tool compile -S)ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ª map åœ¨å¯¹æŸä¸ª key èµ‹å€¼æ—¶æ‰€éœ€è¦åšçš„æ“ä½œ:</p>
<p>m.go:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> m <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    m<span class="token punctuation">[</span><span class="token number">43</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    n<span class="token punctuation">[</span><span class="token string">"abc"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token function">println</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>çœ‹ä¸€çœ‹ç¬¬ä¸ƒè¡Œçš„è¾“å‡º:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token number">0x0085</span> <span class="token number">00133</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">)</span>   LEAQ    <span class="token keyword">type</span><span class="token punctuation">.</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token function">int</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
<span class="token number">0x008c</span> <span class="token number">00140</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">)</span>   MOVQ    AX<span class="token punctuation">,</span> <span class="token punctuation">(</span>SP<span class="token punctuation">)</span>
<span class="token number">0x0090</span> <span class="token number">00144</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">)</span>   LEAQ    <span class="token string">""</span><span class="token punctuation">.</span><span class="token punctuation">.</span>autotmp_2<span class="token operator">+</span><span class="token function">232</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
<span class="token number">0x0098</span> <span class="token number">00152</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">)</span>   MOVQ    AX<span class="token punctuation">,</span> <span class="token function">8</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span>
<span class="token number">0x009d</span> <span class="token number">00157</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">)</span>   MOVQ    $<span class="token number">43</span><span class="token punctuation">,</span> <span class="token function">16</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span>
<span class="token number">0x00a6</span> <span class="token number">00166</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">)</span>   PCDATA  $<span class="token number">0</span><span class="token punctuation">,</span> $<span class="token number">1</span>
<span class="token number">0x00a6</span> <span class="token number">00166</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">)</span>   CALL    runtime<span class="token punctuation">.</span><span class="token function">mapassign_fast64</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span>
<span class="token number">0x00ab</span> <span class="token number">00171</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">)</span>   MOVQ    <span class="token function">24</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
<span class="token number">0x00b0</span> <span class="token number">00176</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">)</span>   MOVQ    $<span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>AX<span class="token punctuation">)</span></code></pre></div>
<p>å‰é¢æˆ‘ä»¬å·²ç»åˆ†æè¿‡è°ƒç”¨å‡½æ•°çš„è¿‡ç¨‹ï¼Œè¿™é‡Œå‰å‡ è¡Œéƒ½æ˜¯åœ¨å‡†å¤‡ runtime.mapassign_fast64(SB) çš„å‚æ•°ã€‚å» runtime é‡Œçœ‹çœ‹è¿™ä¸ªå‡½æ•°çš„ç­¾å:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">mapassign_fast64</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> key <span class="token builtin">uint64</span><span class="token punctuation">)</span> unsafe<span class="token punctuation">.</span>Pointer <span class="token punctuation">{</span></code></pre></div>
<p>ä¸ç”¨çœ‹å‡½æ•°çš„å®ç°æˆ‘ä»¬ä¹Ÿå¤§æ¦‚èƒ½æ¨æµ‹å‡ºå‡½æ•°è¾“å…¥å‚æ•°å’Œè¾“å‡ºå‚æ•°çš„å…³ç³»äº†ï¼ŒæŠŠå…¥å‚å’Œæ±‡ç¼–æŒ‡ä»¤å¯¹åº”çš„è¯:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">t <span class="token operator">*</span>maptype
<span class="token operator">=</span><span class="token operator">></span>
LEAQ    <span class="token keyword">type</span><span class="token punctuation">.</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token function">int</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
MOVQ    AX<span class="token punctuation">,</span> <span class="token punctuation">(</span>SP<span class="token punctuation">)</span>

h <span class="token operator">*</span>hmap
<span class="token operator">=</span><span class="token operator">></span>
LEAQ    <span class="token string">""</span><span class="token punctuation">.</span><span class="token punctuation">.</span>autotmp_2<span class="token operator">+</span><span class="token function">232</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
MOVQ    AX<span class="token punctuation">,</span> <span class="token function">8</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span>

key <span class="token builtin">uint64</span>
<span class="token operator">=</span><span class="token operator">></span>
MOVQ    $<span class="token number">43</span><span class="token punctuation">,</span> <span class="token function">16</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span></code></pre></div>
<p>è¿”å›å‚æ•°å°±æ˜¯ key å¯¹åº”çš„å¯ä»¥å†™å€¼çš„å†…å­˜åœ°å€ï¼Œæ‹¿åˆ°è¯¥åœ°å€åæˆ‘ä»¬æŠŠæƒ³è¦å†™çš„å€¼å†™è¿›å»å°±å¯ä»¥äº†:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">MOVQ    <span class="token function">24</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
MOVQ    $<span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>AX<span class="token punctuation">)</span></code></pre></div>
<p>æ•´ä¸ªè¿‡ç¨‹è¿˜æŒºå¤æ‚çš„ï¼Œæˆ‘ä»¬æ‰‹æŠ„ä¸€éå€’ä¹Ÿå¯ä»¥å®ç°ã€‚ä¸è¿‡è¿˜è¦è€ƒè™‘ï¼Œä¸åŒç±»å‹çš„ mapï¼Œå®é™…ä¸Šéœ€è¦æ‰§è¡Œçš„ runtime ä¸­çš„ assign å‡½æ•°æ˜¯ä¸åŒçš„ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥æ±‡ç¼–æœ¬èŠ‚çš„ç¤ºä¾‹è‡ªè¡Œå°è¯•ã€‚</p>
<p>æ•´ä½“æ¥è®²ï¼Œç”¨æ±‡ç¼–æ¥æ“ä½œ map å¹¶ä¸æ˜¯ä¸€ä¸ªæ˜æ™ºçš„é€‰æ‹©ã€‚</p>
<h4 id="channel"><a href="#channel" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>channel</h4>
<p>channel åœ¨ runtime ä¹Ÿæ˜¯æ¯”è¾ƒå¤æ‚çš„æ•°æ®ç»“æ„ï¼Œå¦‚æœåœ¨æ±‡ç¼–å±‚é¢æ“ä½œï¼Œå®é™…ä¸Šä¹Ÿæ˜¯è°ƒç”¨ runtime ä¸­ chan.go ä¸­çš„å‡½æ•°ï¼Œå’Œ map æ¯”è¾ƒç±»ä¼¼ï¼Œè¿™é‡Œå°±ä¸å±•å¼€è¯´äº†ã€‚</p>
<h3 id="è·å–-goroutine-id"><a href="#%E8%8E%B7%E5%8F%96-goroutine-id" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>è·å– goroutine id</h3>
<p>Go çš„ goroutine æ˜¯ä¸€ä¸ªå« g çš„ç»“æ„ä½“ï¼Œå†…éƒ¨æœ‰è‡ªå·±çš„å”¯ä¸€ idï¼Œä¸è¿‡ runtime æ²¡æœ‰æŠŠè¿™ä¸ª id æš´éœ²å‡ºæ¥ï¼Œä½†ä¸çŸ¥é“ä¸ºä»€ä¹ˆæœ‰å¾ˆå¤šäººå°±æ˜¯æƒ³æŠŠè¿™ä¸ª id å¾—åˆ°ã€‚äºæ˜¯å°±æœ‰äº†å„ç§æˆ–å…¶ goroutine id çš„åº“ã€‚</p>
<p>åœ¨ struct ä¸€å°èŠ‚æˆ‘ä»¬å·²ç»æåˆ°ï¼Œç»“æ„ä½“æœ¬èº«å°±æ˜¯ä¸€æ®µè¿ç»­çš„å†…å­˜ï¼Œæˆ‘ä»¬çŸ¥é“èµ·å§‹åœ°å€å’Œå­—æ®µçš„åç§»é‡çš„è¯ï¼Œå¾ˆå®¹æ˜“å°±å¯ä»¥æŠŠè¿™æ®µæ•°æ®æ¬è¿å‡ºæ¥:</p>
<p>go_tls.h:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">#ifdef GOARCH_arm
#define LR R14
#endif

#ifdef GOARCH_amd64
#define    <span class="token function">get_tls</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>    MOVQ TLS<span class="token punctuation">,</span> r
#define    <span class="token function">g</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>    <span class="token function">0</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">(</span>TLS<span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">)</span>
#endif

#ifdef GOARCH_amd64p32
#define    <span class="token function">get_tls</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>    MOVL TLS<span class="token punctuation">,</span> r
#define    <span class="token function">g</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>    <span class="token function">0</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">(</span>TLS<span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">)</span>
#endif

#ifdef GOARCH_386
#define    <span class="token function">get_tls</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>    MOVL TLS<span class="token punctuation">,</span> r
#define    <span class="token function">g</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>    <span class="token function">0</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">(</span>TLS<span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">)</span>
#endif</code></pre></div>
<p>goid.go:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> goroutineid
<span class="token keyword">import</span> <span class="token string">"runtime"</span>
<span class="token keyword">var</span> offsetDict <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">{</span>
    <span class="token comment">// ... çœç•¥ä¸€äº›è¡Œ</span>
    <span class="token string">"go1.7"</span><span class="token punctuation">:</span>    <span class="token number">192</span><span class="token punctuation">,</span>
    <span class="token string">"go1.7.1"</span><span class="token punctuation">:</span>  <span class="token number">192</span><span class="token punctuation">,</span>
    <span class="token string">"go1.7.2"</span><span class="token punctuation">:</span>  <span class="token number">192</span><span class="token punctuation">,</span>
    <span class="token string">"go1.7.3"</span><span class="token punctuation">:</span>  <span class="token number">192</span><span class="token punctuation">,</span>
    <span class="token string">"go1.7.4"</span><span class="token punctuation">:</span>  <span class="token number">192</span><span class="token punctuation">,</span>
    <span class="token string">"go1.7.5"</span><span class="token punctuation">:</span>  <span class="token number">192</span><span class="token punctuation">,</span>
    <span class="token string">"go1.7.6"</span><span class="token punctuation">:</span>  <span class="token number">192</span><span class="token punctuation">,</span>
    <span class="token comment">// ... çœç•¥ä¸€äº›è¡Œ</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> offset <span class="token operator">=</span> offsetDict<span class="token punctuation">[</span>runtime<span class="token punctuation">.</span><span class="token function">Version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token comment">// GetGoID returns the goroutine id</span>
<span class="token keyword">func</span> <span class="token function">GetGoID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getGoID</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">getGoID</span><span class="token punctuation">(</span>off <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span></code></pre></div>
<p>goid.s:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go">#include <span class="token string">"textflag.h"</span>
#include <span class="token string">"go_tls.h"</span>

<span class="token comment">// func getGoID() int64</span>
TEXT Â·<span class="token function">getGoID</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> NOSPLIT<span class="token punctuation">,</span> $<span class="token number">0</span><span class="token operator">-</span><span class="token number">16</span>
    <span class="token function">get_tls</span><span class="token punctuation">(</span>CX<span class="token punctuation">)</span>
    MOVQ <span class="token function">g</span><span class="token punctuation">(</span>CX<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
    MOVQ <span class="token function">offset</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> BX
    LEAQ <span class="token function">0</span><span class="token punctuation">(</span>AX<span class="token punctuation">)</span><span class="token punctuation">(</span>BX<span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> DX
    MOVQ <span class="token punctuation">(</span>DX<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
    MOVQ AX<span class="token punctuation">,</span> ret<span class="token operator">+</span><span class="token function">8</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span>
    RET</code></pre></div>
<p>è¿™æ ·å°±å®ç°äº†ä¸€ä¸ªç®€å•çš„è·å– struct g ä¸­çš„ goid å­—æ®µçš„å° libraryï¼Œä½œä¸ºç©å…·æ”¾åœ¨è¿™é‡Œ:</p>
<blockquote>
<p><a href="https://github.com/cch123/goroutineid" target="_blank" rel="nofollow noopener noreferrer">https://github.com/cch123/goroutineid</a></p>
</blockquote>
<h3 id="simd"><a href="#simd" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SIMD</h3>
<p><a href="https://cch123.gitbooks.io/duplicate/content/part3/performance/simd-instruction-class.html" target="_blank" rel="nofollow noopener noreferrer">SIMD</a> æ˜¯ Single Instruction, Multiple Data çš„ç¼©å†™ï¼Œåœ¨ Intel å¹³å°ä¸Šçš„ SIMD æŒ‡ä»¤é›†å…ˆåä¸º SSEï¼ŒAVXï¼ŒAVX2ï¼ŒAVX512ï¼Œè¿™äº›æŒ‡ä»¤é›†å¼•å…¥äº†æ ‡å‡†ä»¥å¤–çš„æŒ‡ä»¤ï¼Œå’Œå®½åº¦æ›´å¤§çš„å¯„å­˜å™¨ï¼Œä¾‹å¦‚:</p>
<ul>
<li>128 ä½çš„ XMM0~XMM31 å¯„å­˜å™¨ã€‚</li>
<li>256 ä½çš„ YMM0~YMM31 å¯„å­˜å™¨ã€‚</li>
<li>512 ä½çš„ ZMM0~ZMM31 å¯„å­˜å™¨ã€‚</li>
</ul>
<p>è¿™äº›å¯„å­˜å™¨çš„å…³ç³»ï¼Œç±»ä¼¼ RAXï¼ŒEAXï¼ŒAX ä¹‹é—´çš„å…³ç³»ã€‚æŒ‡ä»¤æ–¹é¢å¯ä»¥åŒæ—¶å¯¹å¤šç»„æ•°æ®è¿›è¡Œç§»åŠ¨æˆ–è€…è®¡ç®—ï¼Œä¾‹å¦‚:</p>
<ul>
<li>movups : æŠŠ4ä¸ªä¸å¯¹å‡†çš„å•ç²¾åº¦å€¼ä¼ é€åˆ°xmmå¯„å­˜å™¨æˆ–è€…å†…å­˜</li>
<li>movaps : æŠŠ4ä¸ªå¯¹å‡†çš„å•ç²¾åº¦å€¼ä¼ é€åˆ°xmmå¯„å­˜å™¨æˆ–è€…å†…å­˜</li>
</ul>
<p>ä¸Šè¿°æŒ‡ä»¤ï¼Œå½“æˆ‘ä»¬å°†æ•°ç»„ä½œä¸ºå‡½æ•°çš„å…¥å‚æ—¶æœ‰å¾ˆå¤§æ¦‚ç‡ä¼šçœ‹åˆ°ï¼Œä¾‹å¦‚:</p>
<p>arr_par.go:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">pr</span><span class="token punctuation">(</span>input <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pr</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>go compile -S:</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token number">0x001d</span> <span class="token number">00029</span> <span class="token punctuation">(</span>arr_par<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">)</span>    MOVQ    <span class="token string">""</span><span class="token punctuation">.</span><span class="token function">statictmp_0</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
<span class="token number">0x0024</span> <span class="token number">00036</span> <span class="token punctuation">(</span>arr_par<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">)</span>    MOVQ    AX<span class="token punctuation">,</span> <span class="token punctuation">(</span>SP<span class="token punctuation">)</span>
<span class="token number">0x0028</span> <span class="token number">00040</span> <span class="token punctuation">(</span>arr_par<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">)</span>    MOVUPS  <span class="token string">""</span><span class="token punctuation">.</span>statictmp_0<span class="token operator">+</span><span class="token function">8</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> X0
<span class="token number">0x002f</span> <span class="token number">00047</span> <span class="token punctuation">(</span>arr_par<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">)</span>    MOVUPS  X0<span class="token punctuation">,</span> <span class="token function">8</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span>
<span class="token number">0x0034</span> <span class="token number">00052</span> <span class="token punctuation">(</span>arr_par<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">)</span>    CALL    <span class="token string">""</span><span class="token punctuation">.</span><span class="token function">pr</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span></code></pre></div>
<p>å¯è§ï¼Œç¼–è¯‘å™¨åœ¨æŸäº›æƒ…å†µä¸‹å·²ç»è€ƒè™‘åˆ°äº†æ€§èƒ½é—®é¢˜ï¼Œå¸®åŠ©æˆ‘ä»¬ä½¿ç”¨ SIMD æŒ‡ä»¤é›†æ¥å¯¹æ•°æ®æ¬è¿è¿›è¡Œäº†ä¼˜åŒ–ã€‚</p>
<p>å› ä¸º SIMD è¿™ä¸ªè¯é¢˜æœ¬èº«æ¯”è¾ƒå¹¿ï¼Œè¿™é‡Œå°±ä¸å±•å¼€ç»†è¯´äº†ã€‚</p>
<h2 id="ç‰¹åˆ«æ„Ÿè°¢"><a href="#%E7%89%B9%E5%88%AB%E6%84%9F%E8%B0%A2" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ç‰¹åˆ«æ„Ÿè°¢</h2>
<p>ç ”ç©¶è¿‡ç¨‹åŸºæœ¬ç¢°åˆ°ä¸å¤ªæ˜ç™½çš„éƒ½å»éªšæ‰°å“å·¨å·¨äº†ï¼Œå°±æ˜¯è¿™ä½ <a href="https://mzh.io/" target="_blank" rel="nofollow noopener noreferrer">https://mzh.io/</a> å¤§å¤§ã€‚ç‰¹åˆ«æ„Ÿè°¢ä»–ï¼Œç»™äº†ä¸å°‘çº¿ç´¢å’Œæç¤ºã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>å‚è€ƒèµ„æ–™</h2>
<ol>
<li><a href="https://quasilyte.github.io/blog/post/go-asm-complementary-reference/#external-resources" target="_blank" rel="nofollow noopener noreferrer">https://quasilyte.github.io/blog/post/go-asm-complementary-reference/#external-resources</a></li>
<li><a href="http://davidwong.fr/goasm" target="_blank" rel="nofollow noopener noreferrer">http://davidwong.fr/goasm</a></li>
<li><a href="https://www.doxsey.net/blog/go-and-assembly" target="_blank" rel="nofollow noopener noreferrer">https://www.doxsey.net/blog/go-and-assembly</a></li>
<li><a href="https://github.com/golang/go/files/447163/GoFunctionsInAssembly.pdf" target="_blank" rel="nofollow noopener noreferrer">https://github.com/golang/go/files/447163/GoFunctionsInAssembly.pdf</a></li>
<li><a href="https://golang.org/doc/asm" target="_blank" rel="nofollow noopener noreferrer">https://golang.org/doc/asm</a></li>
</ol>
<p>å‚è€ƒèµ„æ–™[4]éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œåœ¨è¯¥ slide ä¸­ç»™å‡ºçš„ callee stack frame ä¸­æŠŠ caller çš„ return address ä¹ŸåŒ…å«è¿›å»äº†ï¼Œä¸ªäººè®¤ä¸ºä¸æ˜¯å¾ˆåˆé€‚ã€‚</p>
<!--stackedit_data:
eyJoaXN0b3J5IjpbMTIzMjkyMzE1MSwtMjY3MTA3MzkxLDEyMz
I5MjMxNTEsLTg4Mjc1MTcwNiwtMTc0OTAxODUyMiwtMzQ4MTA0
NjIzLDIwODQwNjM3MjAsLTE1NTYyODU0NDAsMTI2MTcwMTYyMy
w3NTI0MDk2NTUsMTg4NDQ5NTE5MF19
--></div></article></main><aside><h3 style="font-family:Montserrat, sans-serif;margin-top:0.4375rem"><a style="box-shadow:none;text-decoration:none;color:var(--orange)" href="/">F&amp;Y-BLOG</a></h3><div style="display:flex;margin-bottom:3.5rem"><img src="/static/profile-pic-d74f15ac652d51b388dfaa9d564f8c9b.jpg" alt="KimiFdw" style="margin-right:0.875rem;margin-bottom:0;width:3.5rem;height:3.5rem;border-radius:50%"/><p style="max-width:310px;line-height:3.5rem"><a href="#">kimifdw</a> <!-- -->çš„ä¸ªäººåšå®¢.</p></div><nav><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" style="margin-right:20px" href="/thread-safe/">â† <!-- -->çº¿ç¨‹å®‰å…¨æ€§</a></li><li><a rel="next" href="/golang-tool/">golangå‘½ä»¤é›†<!-- --> â†’</a></li></ul></nav></aside></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-103814842-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/go-assembly/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-0610ffb5df8325885ce5.js"],"app":["/app-454927e492eeae3dba5d.js"],"component---src-pages-404-js":["/component---src-pages-404-js-92a9039488494d561edf.js"],"component---src-templates-blog-index-js":["/component---src-templates-blog-index-js-fa5d9ea3f4b6e27743a8.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-a5cf8e1f925daa84ad58.js"]};/*]]>*/</script><script src="/polyfill-0610ffb5df8325885ce5.js" nomodule=""></script><script src="/component---src-templates-blog-post-js-a5cf8e1f925daa84ad58.js" async=""></script><script src="/b42287b7de2077c8bbdf81b8173430c75bb9d1ba-15e706e384a6a6b62cfa.js" async=""></script><script src="/commons-c4326062fba27c33e039.js" async=""></script><script src="/styles-e9d24b1846c7d6eb9685.js" async=""></script><script src="/app-454927e492eeae3dba5d.js" async=""></script><script src="/framework-9f754d8b33503a24e84f.js" async=""></script><script src="/webpack-runtime-dfdca0602395678500cb.js" async=""></script></body></html>