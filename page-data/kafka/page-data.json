{"componentChunkName":"component---src-templates-blog-post-js","path":"/kafka/","result":{"data":{"site":{"siteMetadata":{"title":"F&Y-BLOG","author":"kimifdw"}},"markdownRemark":{"id":"2a8c0bfb-7795-558a-99f0-ef6ae640aff7","html":"<h2 id=\"消息中间件好处\"><a href=\"#%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%A5%BD%E5%A4%84\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>消息中间件好处</h2>\n<ol>\n<li>解耦</li>\n<li>异步</li>\n<li>削峰</li>\n</ol>\n<h2 id=\"消息队列的通信模式\"><a href=\"#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%BC%8F\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>消息队列的通信模式</h2>\n<ol>\n<li>点对点。基于<strong>拉取</strong>或者<strong>轮询</strong>的消息传送模型，发送到队列的消息被一个且只有一个消费者进行处理\n\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/14dcd8ded1a86470488aae045bf38cf9/8d68c/msg-model1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 47.972972972972975%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABg0lEQVQoz3VS2VKDQBDk/3/JxIeo0RdCIhW0DEUQIxXuY4Ec7NLubCRijFPVNSwwPT09q+mpg1nuws59DKPrOlzG5TvOBbLMQpbrSDMddZNAGwUmbiMLemijZhW4EGjbVhVfgkIIIsnQNA3yPEcYTRFENwjjMUr2Ce3IWxCIiHOO9XoN27avKuqJHceB7/vqWQiqPcraozprELKI0PVjcBRFcSar61phv9+rMykj/DQh1SdQaOSfUb4rD3nLFSEhCAJYlgXXdeF5HkzTVMp2ux0Oh4OyhXJeWCjKmcwz2TiWHm6lh+ESRuSgrmpUVaWKaHTDMLBardTzfD7HYrEAY0xNQP9RDqMnbMOR9HEsv0kPBfnQiV9+lWWpzqSCFkDmU3FvQT/+aUnkq1DLIgqtH5E8JAIqpHwt+qbUkLHyeynd2SZF+JC84TG38Ry7YCVTaocb/e/6UNM0zZCkOrJiKu/hVKoPoE3CF9xFr1gm3h8lQ4KhJUPSONHxsZlgs7lHFLn4Ak9gAazDW+E9AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"image\"\n        title=\"\"\n        src=\"/static/14dcd8ded1a86470488aae045bf38cf9/fcda8/msg-model1.png\"\n        srcset=\"/static/14dcd8ded1a86470488aae045bf38cf9/12f09/msg-model1.png 148w,\n/static/14dcd8ded1a86470488aae045bf38cf9/e4a3f/msg-model1.png 295w,\n/static/14dcd8ded1a86470488aae045bf38cf9/fcda8/msg-model1.png 590w,\n/static/14dcd8ded1a86470488aae045bf38cf9/efc66/msg-model1.png 885w,\n/static/14dcd8ded1a86470488aae045bf38cf9/c83ae/msg-model1.png 1180w,\n/static/14dcd8ded1a86470488aae045bf38cf9/8d68c/msg-model1.png 1234w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </li>\n<li>发布订阅\n\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e2eaf44438e619673500081dc6e02c42/c929c/msg-model2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 48.64864864864865%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABp0lEQVQoz31SDU/bMBD1//9FY4INNqmTBt0Qa1olVF2hJCVtYsf2nKT5ertzoasq2Emn2Bff3XvvTszkClO1wr1K0PUdjm0YBpzaaczYGLmcQKoAxsQQ59kUl/YeX2SITOWUAfRDf0jk77GzOeew29XQ2iGOv0Gbc2j7CZvNNYQu/0A6A1s5dG2HNE0xm83Qtu276JIkwWKxoKINmqaiBpJc0bmGYETo4ZGxdV0HKeWhIN9fnY3jeZ6jrut/jSi/7/dnwfpN9RMinaAiGj39absWRVFguVx6JPwNwxDr9drT5Vgcx9RkQKEfyH8R7QlJ8AhxQRpe6Qhf8xB5oXxCVVXYbrcYjUaIogjz+RxBEHgpjDEeoVKSmlpq8p0KXqAwn5FubiBcXcKWDmVdHShwQXaml2WZl4C1bZqGdNv5BnzfS9CgLC3Kyvr3gkaKoWMR9iJaaz3K/xm/YUleh8TU2fkqfsjf+GkecFc8QhJlRvDWupyuTt/z8DStSkArc0P7OIYqIoiz+BZnz3e4fJ7AvdA+Xt7jfTyN8eDTzRirpw80uI+IkzH+Atfn/zUqge2yAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"image\"\n        title=\"\"\n        src=\"/static/e2eaf44438e619673500081dc6e02c42/fcda8/msg-model2.png\"\n        srcset=\"/static/e2eaf44438e619673500081dc6e02c42/12f09/msg-model2.png 148w,\n/static/e2eaf44438e619673500081dc6e02c42/e4a3f/msg-model2.png 295w,\n/static/e2eaf44438e619673500081dc6e02c42/fcda8/msg-model2.png 590w,\n/static/e2eaf44438e619673500081dc6e02c42/efc66/msg-model2.png 885w,\n/static/e2eaf44438e619673500081dc6e02c42/c83ae/msg-model2.png 1180w,\n/static/e2eaf44438e619673500081dc6e02c42/c929c/msg-model2.png 1218w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </li>\n</ol>\n<h2 id=\"kafka-架构\"><a href=\"#kafka-%E6%9E%B6%E6%9E%84\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>kafka 架构</h2>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/21d4b6cfae925ab6ec0709941adbad25/b67f3/kafka-architecture.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 65.54054054054055%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAAC1UlEQVQ4y02SS4/jRBSF8zf5RWxYsEUazXIkpNkgJNQaRTAzQL8m/aCTuJ1OnJdju2yXXX7GsdPJx01ADJaOrst19dW5ddyL2ynzdMDcDEi7DfumZh+OOGqLg7apvCHKviJxBrShzS6w6EJLeiwq6bW2DbdKcWcM3q6l5+0e8Q8PePsBqp3Q1jnhcsTSmWDWI4r5DQt7xMaxyedf0EsLV/b0fIhOQhapwU1TFlqzFmjPlDHbakezbYkzxd5EfH/h8s27lPd/zNDi7NfnmEsnFdgDD5MVF6MEe74m9F1inVGYlEzAvkB7UT3HNBvSakVUrthlmg9/znlzEfL4NCF1Hnj/i89PFwo1uefpaUb/0mdqzwWiMHnBtigo8xwvjmXk7ZCgfcLLZeRswjZLGV0vufyY4E0c1PiBtz9o3r5J2Mi79bjh46cCZ7RBax9HHE5DzUqAK3HZK+tM7u3AvoXUKMo4Qntj4nhGth5SL+9Iwpmsp6SLe+LglkBfEbk3pHL4jcm5KyuuBDirKnqqlgvuHCJJOywdqigh2vyO6/eJ3UuqzYAg+oyKPpHMr4m8H1kuv8OEP6MjLSYMRZpgkgQltefXFmFrE+zGhI1DIykXrstWFRSLKcXsjjxIKVWKmXyh0eocYBa5+J5LkpdU4iwvS7xTKGVt6Jojrx0YE8ppEdG7z/jf9jH9awoZ2euPUb/ZFNMBh67i9HRlgo59EpNhBJSKw3Mom9zCr2280iKQkbe5IRw8Et3amJehAO9JluuzjPxClXapS5lCLQQWM5KUn8XdU5bjZBm99lixOxZn7Wnk7Fe6Q0Wzz9k2hl2Ty0gJpajd5QJL5L9N6dqCg/RWxz3lv2pl3QtfWkLrIHpFWXsCqyN8fv0q+8DLrcYZGKLJ8b9vp6qkNzrpWTTeoxc7SXnSEIy7M+hU1fif+lUtq8eC9V/lGfD/vZOBzbjGHRe4w5LAyfkbK2u/U3xZSAIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"image\"\n        title=\"\"\n        src=\"/static/21d4b6cfae925ab6ec0709941adbad25/fcda8/kafka-architecture.png\"\n        srcset=\"/static/21d4b6cfae925ab6ec0709941adbad25/12f09/kafka-architecture.png 148w,\n/static/21d4b6cfae925ab6ec0709941adbad25/e4a3f/kafka-architecture.png 295w,\n/static/21d4b6cfae925ab6ec0709941adbad25/fcda8/kafka-architecture.png 590w,\n/static/21d4b6cfae925ab6ec0709941adbad25/efc66/kafka-architecture.png 885w,\n/static/21d4b6cfae925ab6ec0709941adbad25/c83ae/kafka-architecture.png 1180w,\n/static/21d4b6cfae925ab6ec0709941adbad25/b67f3/kafka-architecture.png 1338w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<ol>\n<li>消费者组。同一个分区的数据只能被消费者组中的一个消费者消费；同一个消费者组的消费者可以消费同一个 topic 的不同分区的数据</li>\n<li>producer 采用发送 push 的方式将消息发到 broker 上，broker 存储后。由 consumer 采用 pull 模式订阅并消费信息</li>\n<li>partition 是文件，支持多个副本</li>\n</ol>\n<h2 id=\"优点\"><a href=\"#%E4%BC%98%E7%82%B9\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>优点</h2>\n<ol>\n<li>\n<p>顺序读写磁盘。</p>\n<ol>\n<li>顺序读写。按记录的逻辑顺序进行读、写操作的存取方法，即按照信息在存储器中的实际位置所决定的顺序使用信息，不容易删除数据。 2.在 Partition 末尾追加</li>\n</ol>\n</li>\n<li>\n<p>MMAP 内存映射文件。直接利用操作系统的 Page 来实现文件到物理内存的直接映射，完成映射后对物理内存的操作会被同步到硬盘上。</p>\n<ol>\n<li>原理。可以像读写硬盘一样读写内存（逻辑内存），不必关心内存的大小</li>\n</ol>\n</li>\n<li>零拷贝。所有数据通过 DMA（直接内存访问）来进行传输，没有在内存层面去复制数据</li>\n<li>数据批量处理</li>\n<li>\n<p>kafka引擎读写行为特点</p>\n<ul>\n<li>数据的消费频率随时间变化，越久远的数据消费频率越低</li>\n<li>每个分区只有Leader提供读写服务</li>\n<li>对于一个客户端而言，消费行为是线性的，数据并不会重复消费</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"工作流程分析\"><a href=\"#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>工作流程分析</h2>\n<h3 id=\"发送数据\"><a href=\"#%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>发送数据</h3>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e055571ce85dc16eb54bb723e9b9352b/21482/sendMsg.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 44.5945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAACBklEQVQozzWQSXPTQBCF87O5w5ErJ65cuFAslxASqDIxcbxItuIEW/s2krzJcrR4ieWPsRO66tXMdNV873WfidWIYfCbO/8av1RJywgOnOoxMcl9lSLUKMUdyfgWZ9DAlcpc5dQrgj5lOJDq8ygeOBMbDW/3B3d9Q0SbeeVB/cys4gdq0eIQd0/a+i1Kp3nSXrSpow67RJqFKtt4QCENzqK1dEaR6iPostgK/lchgceP+7jHPupRJwqHFx3vRwNPJDz4KeMwI/TMZ2AkQVGtIKprJjL+ZpFRrTc8hsNTin0sAS/QfdSVJt3Texfc0BknXI5KfuolI30sgZs7YgmMjwnnl7jKFat4cpyacjLiyW/KsTs8BS0J61BPVOqpykGeW9nzPQcvmuGGCaH9V+6w0iSsR7DtYsqE0WLMZpaynkxZGgqrqU0SGqzS6LT8zegXlXbBk91kJ42KqcM00FnGNqmQCcXCYrmak2UZVqrgJAPmlkcmQkytzbvzkLcfXd5/9bCHHfLhBQvlnEJvkBoNFD3i1qlouxW2bciRU4t0NSMvcty0h2XdkPoRS8fGbDd4/Vnw6kPEm08J+rBLNfxOpp6zvP3GtPUF1Uhomjktu8C2JNDPNNyijZt3pVpMPI1UG5LbNlNdRfgGSRIQxwEzUyFVf0hdypQXzPtXCOse4RqEzpjAvOcf3f6NrfTCNRIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"image\"\n        title=\"\"\n        src=\"/static/e055571ce85dc16eb54bb723e9b9352b/fcda8/sendMsg.png\"\n        srcset=\"/static/e055571ce85dc16eb54bb723e9b9352b/12f09/sendMsg.png 148w,\n/static/e055571ce85dc16eb54bb723e9b9352b/e4a3f/sendMsg.png 295w,\n/static/e055571ce85dc16eb54bb723e9b9352b/fcda8/sendMsg.png 590w,\n/static/e055571ce85dc16eb54bb723e9b9352b/efc66/sendMsg.png 885w,\n/static/e055571ce85dc16eb54bb723e9b9352b/c83ae/sendMsg.png 1180w,\n/static/e055571ce85dc16eb54bb723e9b9352b/21482/sendMsg.png 1350w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<ul>\n<li>消息写入 leader 后，follower 是主动的去 leader 进行同步。</li>\n<li>producer 采用<strong>push 模式</strong>将数据发布到 broker，每条消息追加到分区中，顺序写入磁盘，保证同一分区内的数据是<strong>有序</strong>的。\n\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/857ce366a019424d99deba077205247f/c2d9c/writeMsg.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 47.2972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABYklEQVQoz2VS2W7CMBDM//9QnwoBVQLCoUpU7UMfKtHmIOS2E0IOpmMnoYGuNJrJ2lnPrm2gj6ZtIcvyH/LLBWGawvF9ZEWhvyVRcb+K6/V6YwVDSomSGz0hMItizOOkR6fNMNT8wqI6zz1mkuItioBR0VtB0Rf0ycskwYqbx1iywDIe8mTqRZrhnQfJLEPbOxzCGETEopbnYX08alhexyvXvcvrNf+E7zxHU9UocomfU4oPW+DTSWAEQYCMJzts2cwE5kJiNoJq75Ynz1KBCfWOMy3YVZpEWOy/8PR6wnTv/jmMczq0Hawdt0enLduG5dznlfsD2z2zq4Io6TTNS4iihJFw2AXdKYcTuplyPmM8c4Yqb1Lrdc7wmU43HEPJdh/DOPNpNHWNkA63YYRd1GHb8yYI7/I76g1fwIEz1Df8WHAQyn7D96VC3XrJHzRG+kItOO+MBYcn05KrqkJNU4p/Ads6pvVUUxKEAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"image\"\n        title=\"\"\n        src=\"/static/857ce366a019424d99deba077205247f/fcda8/writeMsg.png\"\n        srcset=\"/static/857ce366a019424d99deba077205247f/12f09/writeMsg.png 148w,\n/static/857ce366a019424d99deba077205247f/e4a3f/writeMsg.png 295w,\n/static/857ce366a019424d99deba077205247f/fcda8/writeMsg.png 590w,\n/static/857ce366a019424d99deba077205247f/efc66/writeMsg.png 885w,\n/static/857ce366a019424d99deba077205247f/c83ae/writeMsg.png 1180w,\n/static/857ce366a019424d99deba077205247f/c2d9c/writeMsg.png 1326w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </li>\n<li>\n<p>写入原则</p>\n<ul>\n<li>按指定 partition 写入</li>\n<li>按 key 的 hash 值算出 partition 写入【消息被均匀的分布到不同的 partition 中，才能实现了水平扩展】</li>\n<li>没有设置 key，轮询选出一个 partition</li>\n</ul>\n</li>\n<li>\n<p>消息可靠性保证</p>\n<ul>\n<li>0。不需要等到集群返回，不能保证消息发送成功。</li>\n<li>1。只要 leader 应答就可以发送下一条，只确保 leader 发送成功</li>\n<li>all[-1]。需要所有 follower 都完成 leader 的同步才会发送下一条，确保 leader 发送成功和所有的副本完成备份</li>\n</ul>\n</li>\n<li>\n<p>CP【一致性和分区容错性】配置</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">request.required.acks<span class=\"token operator\">=</span>-1\nmin.insync.replicas <span class=\"token operator\">=</span> <span class=\"token variable\">${N<span class=\"token operator\">/</span>2 + 1}</span>\nunclean.leader.election.enable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></code></pre></div>\n<p>AP【可用性和分区容错性】配置</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">request.required.acks<span class=\"token operator\">=</span><span class=\"token number\">1</span>\nmin.insync.replicas <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\nunclean.leader.election.enable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></code></pre></div>\n</li>\n<li>\n<p>Producer写入\nServer端的I/O线程统一将请求中的数据写入到操作系统的PageCache后立即返回，当消息条数到达一定阈值后，Kafka应用本身或操作系统内核会触发强制刷盘操作\n\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d256acbf1cd91ddb0559e1ca7d51a80c/6728c/producer.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 303px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 110.13513513513513%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAIAAABPIytRAAAACXBIWXMAAAsTAAALEwEAmpwYAAACBUlEQVQ4y32UW2/aQBCF/f//Tl/z0ocmlVopIVJUtUXYJmCDMV4gvmCvL/m8gxcSHI6Qtd6ZM3N8ZhcniqI0Td8GHA6HMAzXA4gul8vdbneZY+EQ6LqubdvOoGma/X5PapZlhPM8p1xVVd0YTmQ4rUFd10mS0DAIgjiO5Snk9grjncuyzAygkaC1vtXZkgGEoihQiwSqfKX5TK4H0BmO53mu6/434JVNqWJzTmRE8kJAX4AdrEI2a0LClBwpcSIvFgvy0o+AhqLtdssiHYOMwEGhyG4uwM5qtcLn65DMBWY/5/l8/skw1jA5G77v88GfogL0098hQ8J9zb5J3bTNNo7hIwqyDJ9sK0Hk9GRclc/rjak01mR5zrmczVy8EC8tjRKYZ7oYMuUhJ0r1Yqo8WHjpIYnXwXoVUohsOlMFCUop5j8mGyVlWge//N/fope7LplkKti/pXjGLPEWa7gwmPSBLIYZD5tO50Wmlt4/9+/z3JuhnFHZqd4yjIcus3XgJ5vw/uHn4+PTZDJBsJDlbH1B7qmZfn0oZt+r1x9/Xp6jzYYwRipjB9eLq2bHdtWZX112TdXqI8Ycj0c7Hnsfb8g+AwJToNvoCRFyf8IgU0MsFbBLZzYZoewQ3RnYHLnzjnySlJcnJjEVvtaeVjnP9iae7zNnGH4ygDX/e9PpFNlqgOxf4x0uk/K8wDcADAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"image\"\n        title=\"\"\n        src=\"/static/d256acbf1cd91ddb0559e1ca7d51a80c/6728c/producer.png\"\n        srcset=\"/static/d256acbf1cd91ddb0559e1ca7d51a80c/12f09/producer.png 148w,\n/static/d256acbf1cd91ddb0559e1ca7d51a80c/e4a3f/producer.png 295w,\n/static/d256acbf1cd91ddb0559e1ca7d51a80c/6728c/producer.png 303w\"\n        sizes=\"(max-width: 303px) 100vw, 303px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h3 id=\"kafka-消息备份和同步\"><a href=\"#kafka-%E6%B6%88%E6%81%AF%E5%A4%87%E4%BB%BD%E5%92%8C%E5%90%8C%E6%AD%A5\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>kafka 消息备份和同步</h3>\n</li>\n<li>根据分区的多副本策略来解决消息的备份问题</li>\n<li>\n<p>名词解释</p>\n<ol>\n<li>ISR : leader 副本保持一定同步的 follower 副本, 包括 leader 副本自己，叫 In Sync Replica，最终会反馈到 zookeeper 上。</li>\n<li>AR: 所有副本 (replicas) 统称为 assigned replicas, 即 AR</li>\n<li>OSR: follower 同 leader 同步数据有一些延迟的节点</li>\n<li>HW: Highwater, 俗称高水位，它表示了一个特定的消息偏移量(offset), 在一个 parttion 中 consumer 只能拉取这个 offset 之前的消息(此 offset 跟 consumer offset 不是一个概念) ；</li>\n<li>LEO: LogEndOffset, 日志末端偏移量, 用来表示当前日志文件中下一条写入消息的 offset；</li>\n<li>leader HW: 该 Partititon 所有副本的 LEO 最小值；</li>\n<li>follower HW: min(follower 自身 LEO 和 leader HW)；</li>\n<li>Leader HW = 所有副本 LEO 最小值；</li>\n<li>Follower HW = min(follower 自身 LEO 和 leader HW)。</li>\n</ol>\n</li>\n<li>\n<p>副本</p>\n<ol>\n<li>定义。在不同节点上持久化同一份数据，当某一个节点上存储的数据丢失时，可以从副本上读取该数据</li>\n<li>分配规则。每个Broker都有均等分配Partition的Leader机会\n\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/575454e10c0aa764ad1451a24e336672/e9c9b/partition.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 39.189189189189186%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAABlklEQVQY01VRWUtCQRj1b0YFQUVBL61vFlGpWdlC2YMhZUm2GQUuES1kD7fQMouwwrJutgpd0rzXO98sfWO+BGfgcJjzzXfOWHTd1A1iGiUghDJBKYISvUg5EoYKcgAqdeRlA8pl5JxzIYRFVXP3D4/F/DPoBcYFwxs4SnsD5BQnCPh+ZVBm8rKgusYNDacAVMx4Iomv2WDSE8qk1VImV5hdTXjXlOjph2HSYOzNsxb3RbL3Lz+xK21h+zKw95hWf4SomDkTk1vR7rmJbu/MYeopmVKnHePzo8715fBnUVgn462dW609kaPz/LJ3d6DFYW93H8Yy6MTN5cu9Y6G2ur7m+sHw8cNBKlszPNI0MdTn3/goCIcr4LJandZ+JXFjd8drG7x1jUubO3f8z4zJfdH0iO/M4Ysnbj+vsnnbyokreLq0f100YCqYdPpPbIvKxd27J3TT5VY6ZpT9sxwFNAsLIXJ7AFkVoxyJjMMFxiEmx8rkF8gWOQEOWBUVJuElXVQLqwRASYJAlfzxf5AiN00Jw2Do+gXMupwYuIUHdAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"image\"\n        title=\"\"\n        src=\"/static/575454e10c0aa764ad1451a24e336672/fcda8/partition.png\"\n        srcset=\"/static/575454e10c0aa764ad1451a24e336672/12f09/partition.png 148w,\n/static/575454e10c0aa764ad1451a24e336672/e4a3f/partition.png 295w,\n/static/575454e10c0aa764ad1451a24e336672/fcda8/partition.png 590w,\n/static/575454e10c0aa764ad1451a24e336672/e9c9b/partition.png 627w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </li>\n<li>\n<p>分配算法。</p>\n<ul>\n<li>将所有N Broker和待分配的i个Partition排序</li>\n<li>将第i个Partition分配到第(i mod n)个Broker上</li>\n<li>将第i个Partition的第j个副本分配到第((i + j) mod n)个Broker上</li>\n</ul>\n</li>\n</ol>\n</li>\n<li>\n<p>消息接收</p>\n<ol>\n<li>主要利用了操作系统的<strong>ZeroCopy</strong>机制，当Kafka Broker接收到读数据请求时，会向操作系统发送sendfile系统调用，操作系统接收后，首先试图从PageCache中获取数据\n\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7244339f04d74916f859ee6e44fc51fb/d0c94/producer2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 383px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 85.13513513513513%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsTAAALEwEAmpwYAAABpElEQVQ4y22T226DQAxE+f8/ax/6FKlNpQRKEu53WCDhkh5wQxaaEUK7rMceewejWKMsS8/zXNf1fd+bEYZhVVXlDALyPJfILMuM+z8opYIgSJIkneE4zvV6bZqm7/txHPXIiTw+MAwDW+osTNJThO8w27alOIlW5A0kEUFEy1Y/InXXdavKgwY0n04n0zQvlwvN07Z8pzhry7Js2+YIXcbtdlNr1DNQrl5BjqhPSYM2kEHWbg2Zk3zXT1kLn7XBSvh6Y1zP4XCIwnDhyCwFbIUykeM4Rg+cJTQvqjjNS1X3450i9Mkg+I4W3lC47Ykst8pgpCWaqZsmcY/n7w+eIrD6YZo2o1mKk4L7+yNzwBhJIU6qlCpD0/58P3+9tclPpeosTZk/EqIooiy0J3lzk5trp+But9vv9xiW7FiNYqTgbbCBTw+ijdwE1ehHUXIcizPJCMVqiGKQYnKUT2QO4JNSxsjVizbs3xXOWEdSXHwqZJncRIYmk+AtxpSRYCOx8eJ5CZD1UzZ83UPVjOm3ePwemwCJwS0vfgyp5s/AAkjVHaLjF+EW1CMmuvuyAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"image\"\n        title=\"\"\n        src=\"/static/7244339f04d74916f859ee6e44fc51fb/d0c94/producer2.png\"\n        srcset=\"/static/7244339f04d74916f859ee6e44fc51fb/12f09/producer2.png 148w,\n/static/7244339f04d74916f859ee6e44fc51fb/e4a3f/producer2.png 295w,\n/static/7244339f04d74916f859ee6e44fc51fb/d0c94/producer2.png 383w\"\n        sizes=\"(max-width: 383px) 100vw, 383px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </li>\n<li>如果数据不存在，会触发缺页异常中断将数据从磁盘读入到临时缓冲区中，随后通过DMA操作直接将数据拷贝到网卡缓冲区中等待后续的TCP传输。\n\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/61794ddb39ec1a2b2862e39a9821176f/045fd/producer3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 403px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 81.08108108108108%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAAsTAAALEwEAmpwYAAAByklEQVQoz12TzXbqMAyE8/4P1FUfoLu2i/a0FwoNJMQJiQHnr4lj6IdFfcjVwkeY0UgzVqKfeYzjWFXVbrcrikIplSSJ1rppmr7v+XcYhoDkMrrcxfl85jTG5Hl+OBzKssyyrK5ra23XddSTBDBEs2KJaZpgAUoCWhg5nXNt28IyK3Y+QjGdabvf708+KAjFJPxkZhLOCPrBB00QzEkxAyMYCvQzdsAAIAdA8UhnxhM/mEemgpITnyCSvPUBhkEwcrvd+rlMJGXw3cvOi2K1+vI9b5qDTkhzHwwVwQ0f9YC8Ve5ydlWlM1XUDaSOJpvNhlEFEGTb0UaQoZBh+AMZddufuulQFlrFWn0PnbGTY24kiPnYBhHN0B/J62FPliljTqmqXv7l6er9/elh9fJom/z6eHY2PB7NisOG0CTZxmju+h+Bgluv1yjEfHk2Me9WLO7LYEhA5PF4NOY4VovLaMpKf358IDtNU07aApZnuxVzJauCedJB0yt5+/p8/Y432AMMUh6JmvDmEWWyvbLusi1c0mSwDiOefYjhAoAawHU9Ze/u15Pcj82Sapbg/rMRmLhz7az+Iv8L8sVisVwuOeM4lhs+r/8w3PwCVD6UQ1rvpOEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"image\"\n        title=\"\"\n        src=\"/static/61794ddb39ec1a2b2862e39a9821176f/045fd/producer3.png\"\n        srcset=\"/static/61794ddb39ec1a2b2862e39a9821176f/12f09/producer3.png 148w,\n/static/61794ddb39ec1a2b2862e39a9821176f/e4a3f/producer3.png 295w,\n/static/61794ddb39ec1a2b2862e39a9821176f/045fd/producer3.png 403w\"\n        sizes=\"(max-width: 403px) 100vw, 403px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </li>\n</ol>\n</li>\n</ul>\n<h3 id=\"保存数据\"><a href=\"#%E4%BF%9D%E5%AD%98%E6%95%B0%E6%8D%AE\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>保存数据</h3>\n<blockquote>\n<p>顺序写入的方式将数据保存到磁盘</p>\n</blockquote>\n<h4 id=\"partition-结构\"><a href=\"#partition-%E7%BB%93%E6%9E%84\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>partition 结构</h4>\n<blockquote>\n<p>以文件夹的方式在服务器中存储</p>\n</blockquote>\n<ol>\n<li>影响分区数量的因素</li>\n<li>生产者的峰值带宽</li>\n<li>消费者的峰值带宽</li>\n<li>消费者的消费能力。同一个消费组里同一个分区只能被一个消费者消费</li>\n<li>\n<p>选取合适的分区数量</p>\n<blockquote>\n<p>建议分区的数量一定要大于等于消费者的数量来实现最大并发</p>\n</blockquote>\n</li>\n<li>\n<p>Num=max(T/PT,T/CT)=T/min(PT,CT)</p>\n<ol>\n<li>Num：分区数</li>\n<li>T：目标吞吐量</li>\n<li>PT：生产者写入单个分区的最大吞吐量</li>\n<li>CT：消费者从单个分区消费的最大吞吐</li>\n<li>分区数量=T/PT 和 T/CT 中的</li>\n</ol>\n</li>\n<li>PT 影响的因素：批处理的规模、压缩算法、确认机制、副本数等有关</li>\n<li>信息参考</li>\n<li>单个分区可以实现消息的顺序写入</li>\n<li>单个分区只能被同消费组的单个消费者进程消费</li>\n<li>单个消费者进程可同时消费多个分区</li>\n<li>分区越多，当 Leader 节点失效后，其他分区重新进行 Leader 选举的耗时会越长</li>\n<li>分区的数量是可以动态增加的，只增不减，但增加会出现 rebalance 的情况</li>\n</ol>\n<h4 id=\"message-结构\"><a href=\"#message-%E7%BB%93%E6%9E%84\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>message 结构</h4>\n<ol>\n<li>offset。占 8byte 的有序 id 号，唯一确定每条消息在 partition 内的位置</li>\n<li>消息大小</li>\n<li>消息体。</li>\n</ol>\n<h4 id=\"文件存储设计特点\"><a href=\"#%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E8%AE%BE%E8%AE%A1%E7%89%B9%E7%82%B9\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>文件存储设计特点</h4>\n<ol>\n<li>Kafka把topic中一个parition大文件分成多个小文件段，通过多个小文件段，就容易定期清除或删除已经消费完文件，减少磁盘占用。</li>\n<li>通过<strong>索引</strong>信息可以快速定位message和确定response的最大大小。</li>\n<li>通过<strong>index元数据</strong>全部映射到memory，可以避免segment file的IO磁盘操作。</li>\n<li>通过<strong>索引文件</strong>稀疏存储，可以大幅降低index文件元数据占用空间大小。</li>\n</ol>\n<h4 id=\"存储策略\"><a href=\"#%E5%AD%98%E5%82%A8%E7%AD%96%E7%95%A5\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>存储策略</h4>\n<ol>\n<li>基于时间，默认 7 天；</li>\n<li>基于大小，默认 128MB;</li>\n</ol>\n<h3 id=\"消费数据\"><a href=\"#%E6%B6%88%E8%B4%B9%E6%95%B0%E6%8D%AE\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>消费数据</h3>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0f621570a5670beaf3b6b66ef87df287/21482/consumer-msg.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 39.189189189189186%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABpklEQVQoz22SWW/bMBCE9f9/UB7S9ABSS/XR2padNLZq6L4oSorOGtYxHSnJWwl8WILkzg6XVPA+hnFEPwwY3pnmI9erqkJJ2rZF0zaknbler/jfUKbDdVnilOdQE4mVTKHKDFqSYsm5HWpYhxa+RwKLMMJjEGIjJfLXV6aPGPvujWGih9I0Df6yokXBX7HAXiS4SBPPSYidkDhLD0eZYM9iOtlx/1QUqOoaaZbjaNjQTyaxcDhbUGputBS9UHAtYlbPYPob6L6BJV0twxirKKLLECvyIwiwp8OqKmGYLj7pEe7WJu42Dh52PpSpUkv+5BlUCnjyiK17wjfTgeZ5UF2XvMWF4+LRdrDh1cuygOkGeDgI3O8Y9Rif9RDKrevQk4iil6qGHRl4CSz8Zv+ehZh5ofOP+VMcw0hTZFk6C355SnC/pdN9gK8HChbsx/QoZ15ZSxKoIsWCTjUmqkSLI3jxCj+FB439U3n9bZahYE5ZVghEBj9O5xgwV+n6Hj0p+Q0S9jLlA30gSc51LzRhhgEc9s6mSz/NIOlyGt3thqbmt2rqOf4DC1ZSdPm3ouIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"image\"\n        title=\"\"\n        src=\"/static/0f621570a5670beaf3b6b66ef87df287/fcda8/consumer-msg.png\"\n        srcset=\"/static/0f621570a5670beaf3b6b66ef87df287/12f09/consumer-msg.png 148w,\n/static/0f621570a5670beaf3b6b66ef87df287/e4a3f/consumer-msg.png 295w,\n/static/0f621570a5670beaf3b6b66ef87df287/fcda8/consumer-msg.png 590w,\n/static/0f621570a5670beaf3b6b66ef87df287/efc66/consumer-msg.png 885w,\n/static/0f621570a5670beaf3b6b66ef87df287/c83ae/consumer-msg.png 1180w,\n/static/0f621570a5670beaf3b6b66ef87df287/21482/consumer-msg.png 1350w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<ol>\n<li>点对点模式。由消费者主动去 kafka 集群拉取消息</li>\n<li>消费者组 consumer 的数量与 partition 的数量一致</li>\n</ol>\n<h4 id=\"消费场景\"><a href=\"#%E6%B6%88%E8%B4%B9%E5%9C%BA%E6%99%AF\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>消费场景</h4>\n<ol>\n<li>AutoCommit（实际消息会丢）</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">    enable.auto.commit <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    // 自动提交的时间间隔\n    auto.commit.interval.ms</code></pre></div>\n<ol start=\"2\">\n<li>手动 commit（at least once，消息重复，重启会丢）</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">    // oldest:topic里最早的消息，大于commit的位置，小于HW，也受到broker上消息保留时间和位移影响，不保证一定能消费到topic起始位置的消息\n    sarama.offset.initial （oldest, newest）\n    // 主题偏移量日志文的保留时长，默认设为1440s\n    offsets.retention.minutes</code></pre></div>\n<h4 id=\"消费原理\"><a href=\"#%E6%B6%88%E8%B4%B9%E5%8E%9F%E7%90%86\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>消费原理</h4>\n<ol>\n<li>数据异步批量的存储在磁盘中，采用批量刷盘的做法进行，即按照一定的消息量和时间间隔进行刷盘。先存储到页缓存（Page cache）中，按照时间或者其他条件进行刷盘，或通过 fsync 命令强制刷盘。做不到不丢失消息，只能通过调整刷盘机制的参数缓解该情况</li>\n<li>通过 ack 的方式来处理消息丢失的情况</li>\n</ol>\n<h2 id=\"指令\"><a href=\"#%E6%8C%87%E4%BB%A4\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>指令</h2>\n<ol>\n<li>创建 topic</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">./kafka-topics.sh --create --topic dev2wx --replication-factor 1 --partitions 2 --zookeeper master:2181</code></pre></div>\n<ol start=\"2\">\n<li>查看 topic</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">./kafka-topics.sh --list --zookeeper master:2181</code></pre></div>\n<ol start=\"3\">\n<li>查看 consumer list</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">./kafka-consumer-groups.sh --bootstrap-server master:9092 --list</code></pre></div>\n<p>./kafka-topics.sh —list —zookeeper master:2181 4. 消费积压情况</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">./kafka-consumer-groups.sh --bootstrap-server master:9092 --describe --group logstash</code></pre></div>\n<h2 id=\"资料\"><a href=\"#%E8%B5%84%E6%96%99\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>资料</h2>\n<ol>\n<li><a href=\"https://mp.weixin.qq.com/s/T6gCc8OBgyV-yeAg_MUzPQ\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">简单理解 kafka 的消息可靠性</a></li>\n<li><a href=\"https://blog.csdn.net/MeituanTech/article/details/112645937\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">基于SSD的Kafka应用层缓存架构设计与实现</a></li>\n<li><a href=\"https://tech.meituan.com/2015/01/13/kafka-fs-design-theory.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Kafka文件存储机制那些事</a></li>\n<li><a href=\"https://blog.csdn.net/lizhitao/article/details/25667831\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">kafka服务器配置</a></li>\n</ol>","timeToRead":9,"frontmatter":{"title":"kafka原理","date":"January 19, 2021","spoiler":"原理"},"fields":{"slug":"/kafka/"}}},"pageContext":{"slug":"/kafka/","previous":{"fields":{"slug":"/git shell/","directoryName":"git shell"},"frontmatter":{"title":"git日常易被遗忘的命令"}},"next":{"fields":{"slug":"/jvm/","directoryName":"jvm"},"frontmatter":{"title":"jvm"}}}},"staticQueryHashes":["336482444"]}